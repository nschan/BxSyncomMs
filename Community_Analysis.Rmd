---
title: "Syncom community analysis"
author: "Niklas Schandry"
date: "2020"
output: 
  html_document:
    fig_caption: yes
## Widescreen figures
    fig_height: 9
    fig_width: 16
## Highlighting    
    highlight: zenburn
    theme: cosmo
### TOC    
    toc: yes
    toc_float: yes
---

# About

This file documents the community analysis and figure generation for Schandry, et al., 2021, bioRxiv.
Currently this document is subject to change.

# Prepare session

## Libraries and functions

```{r load libraries, message = F}
library(tidyverse)
library(phyloseq)
library(patchwork)
library(magrittr)
library(ggnetwork)
library(emmeans)
require(vegan)
```

```{r load functions}
source("functions/get_counts_and_overlay.R")
source("functions/create_corrnet.R")
source("functions/overlay_corrnet.R")
source("functions/fix_node_placement.R")
source("functions/compare_conditions.R")
source("functions/read_fasta.R")
```

```{r}
syncom_colors <- c("Random" = "#666699",
                  "Tolerant" = "#9BCB40",
                  "Mixed" = "#B6539F",
                  "Sensitive" = "#FEE377")
```


# Data removal

Replicate 1, appears to have issues that are more pronounced in some samples than in others. This replicate is removed from all Syncoms, leaving four replicates.

# Prepare Data

## General data

```{r}
tax_info <- read_rds("files_publication/taxonomy.rds")
### read growth data
AUC_emmeans <- read_rds("files_publication/AUC_emmeans_pub.rds") %>% 
  left_join(tax_info %>%
            dplyr::select(Genus, Class, Order), by = "Genus")
AUC_vals <- AUC_emmeans %>% 
             mutate(Chem_conc = paste0(Chem,Conc)) %>% 
             dplyr::select(Strain, Chem_conc, AUC) %>%
             pivot_wider(id_cols = Strain, names_from = Chem_conc, values_from = AUC,
                         values_fn = mean) %>%
             as.data.frame() %>% 
             dplyr::mutate(Control = `0_Control0`) %>% 
             dplyr::select("Strain","APO50", "BOA100", "Control" ) 
syncoms_memberships <- read_rds("files_publication/syncom_membership.rds")
```

## Syncom Members

### Tab S1

```{r}
syncoms_memberships %>% 
  group_by(Syncom) %>% 
  arrange(Genus) %>% 
  gt::gt()
```


## Random

```{r read objects for phyloseq random}
# Read sequence table
syncomRandom_noChim    <-  readRDS("files_publication/syncom_full_random_seqtable_nochim.rds")
syncomRandom_tax       <-  dada2::assignTaxonomy(seqs = syncomRandom_noChim,
                                    "files_publication/syncom_full_random_16SrRNA.fasta",
                                     taxLevels = c("Kingdom", "Phylum", "Family", "Genus", "Strain"))
syncomRandom_metadata  <-  readRDS("files_publication/Metadata_publication.rds") %>% 
                              filter(Syncom == "Full_Random")

syncomRandom_strains <-  read_rds("files_publication/syncom_full_random.rds") %>%
  mutate(SynCom = "Random")
```

```{r}
phyl_random <- phyloseq(otu_table(syncomRandom_noChim, taxa_are_rows =F),
                  sample_data(syncomRandom_metadata),
                  tax_table(syncomRandom_tax),
                  phy_tree(read_rds("files_publication/syncom_full_random_GTR_tree.rds")$tree))

phyl_random_glom_strain <- phyl_random %>%
  subset_samples(Rep != "Rep_1") %>%
  tax_glom("Strain")
phyl_random_rel_strain <- transform_sample_counts(phyl_random_glom_strain, function(x) x / sum(x) ) 
```

## Tolerant

```{r read objects for phyloseq tolerant}
# Read sequence table
syncomTolerant_noChim   <-  readRDS("files_publication/syncom_reduced_tolerant_seqtable_nochim.rds")
syncomTolerant_tax      <- dada2::assignTaxonomy(seqs = syncomTolerant_noChim,
                                     "files_publication/syncom_reduced_tolerant_16SrRNA.fasta",
                                      taxLevels = c("Kingdom", "Phylum", "Family", "Genus", "Strain"))
syncomTolerant_metadata <-  readRDS("files_publication/Metadata_publication.rds") %>%
                          filter(Syncom == "Reduced_Tolerant")

syncomTolerant_strains <-  read_rds("files_publication/syncom_reduced_tolerant.rds") %>%
  mutate(SynCom = "Tolerant")
```

```{r}
phyl_tolerant <- phyloseq(otu_table(syncomTolerant_noChim, taxa_are_rows =F),
                  sample_data(syncomTolerant_metadata),
                  tax_table(syncomTolerant_tax),
                  phy_tree(read_rds("files_publication/syncom_reduced_tolerant_GTR_tree.rds")$tree))

phyl_tolerant_glom_strain <- phyl_tolerant %>% 
  subset_samples(Rep != "Rep_1") %>%
  tax_glom("Strain")
phyl_tolerant_rel_strain <- transform_sample_counts(phyl_tolerant_glom_strain, function(x) x / sum(x) ) 
```

## Mixed


```{r read objects for phyloseq mixed}
# Read sequence table
syncomMixed_noChim <-  readRDS("files_publication/syncom_reduced_mixed_seqtable_nochim.rds")
syncomMixed_tax <- dada2::assignTaxonomy(seqs = syncomTolerant_noChim,
                                     "files_publication/syncom_reduced_mixed_16SrRNA.fasta",
                                      taxLevels = c("Kingdom", "Phylum", "Family", "Genus", "Strain"))
syncomMixed_metadata        <-  readRDS("files_publication/Metadata_publication.rds") %>%                                   filter(Syncom == "Reduced_Mixed")

syncomMixed_strains <-  read_rds("files_publication/syncom_reduced_mixed.rds") %>%
  mutate(SynCom = "Mixed")
```

```{r}
phyl_mixed <- phyloseq(otu_table(syncomMixed_noChim, taxa_are_rows =F),
                  sample_data(syncomMixed_metadata),
                  tax_table(syncomMixed_tax),
                  phy_tree(read_rds("files_publication/syncom_reduced_mixed_GTR_tree.rds")$tree))

phyl_mixed_glom_strain <- phyl_mixed %>%
  subset_samples(Rep != "Rep_1") %>%
  tax_glom("Strain")
phyl_mixed_rel_strain <- transform_sample_counts(phyl_mixed_glom_strain, function(x) x / sum(x) ) 
```

## Sensitive


```{r read objects for phyloseq sensitive}
# Read sequence table
syncomSensitive_noChim <-  readRDS("files_publication/syncom_reduced_sensitive_seqtable_nochim.rds")
syncomSensitive_tax <- dada2::assignTaxonomy(seqs = syncomTolerant_noChim,
                                     "files_publication/syncom_reduced_sensitive_16SrRNA.fasta",
                                      taxLevels = c("Kingdom", "Phylum", "Family", "Genus", "Strain"))
syncomSensitive_metadata        <-  readRDS("files_publication/Metadata_publication.rds") %>%                                   filter(Syncom == "Reduced_Sensitive")

syncomSensitive_strains <-  read_rds("files_publication/syncom_reduced_sensitive.rds") %>%
  mutate(SynCom = "Tolerant")
```

```{r}
phyl_sensitive <- phyloseq(otu_table(syncomSensitive_noChim, taxa_are_rows =F),
                  sample_data(syncomSensitive_metadata),
                  tax_table(syncomSensitive_tax),
                  phy_tree(read_rds("files_publication/syncom_reduced_sensitive_GTR_tree.rds")$tree))

phyl_sensitive_glom_strain <- phyl_sensitive %>%
  subset_samples(Rep != "Rep_1") %>%
  tax_glom("Strain")
phyl_sensitive_rel_strain <- transform_sample_counts(phyl_sensitive_glom_strain, function(x) x / sum(x) ) 
```


# Beta Diverstiy


### PCoA with jaccard

```{r}
pcoa_jaccard_random_rel_strain <-  phyl_random_rel_strain %>%
  ordinate("PCoA", distance = "jaccard") 
pcoa_jaccard_random_plot<- plot_ordination(phyl_random_rel_strain,
                pcoa_jaccard_random_rel_strain,
                color = "Treatment",
                axes = c(1,2)) +
  ggforce::geom_mark_ellipse(fill = "grey90") +
  geom_point() +
  facet_grid(~Timepoint) +
  geom_point(size = 3) +
  geom_point(size = 3, pch = 21, color = "black") +
  ggtitle(paste("Random Syncom: PCoA")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(text = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        strip.background = element_rect(fill = "white"))  

pcoa_jaccard_tolerant_rel_strain <-  phyl_tolerant_rel_strain %>%
  ordinate("PCoA", "jaccard") 
pcoa_jaccard_tolerant_plot <- plot_ordination(phyl_tolerant_rel_strain,
                pcoa_jaccard_tolerant_rel_strain,
                color = "Treatment",
                axes = c(1,2)) +
  ggforce::geom_mark_ellipse(fill = "grey90") +
  geom_point() +
  facet_grid(~Timepoint) +
  geom_point(size = 3) +
  geom_point(size = 3, pch = 21, color = "black") +
  ggtitle(paste("Tolerant Syncom: PCoA")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(text = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        strip.background = element_rect(fill = "white"))  

pcoa_jaccard_mixed_rel_strain <-  phyl_mixed_rel_strain %>%
  ordinate("PCoA", "jaccard") 
pcoa_jaccard_mixed_plot <- plot_ordination(phyl_mixed_rel_strain,
                pcoa_jaccard_mixed_rel_strain,
                color = "Treatment",
                axes = c(1,2)) +
  ggforce::geom_mark_ellipse(fill = "grey90") +
  geom_point() +
  facet_grid(~Timepoint) +
  geom_point(size = 3) +
  geom_point(size = 3, pch = 21, color = "black") +
  ggtitle(paste("Mixed Syncom: PCoA")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(text = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        strip.background = element_rect(fill = "white"))  

pcoa_jaccard_sensitive_rel_strain <-  phyl_sensitive_rel_strain %>%
  ordinate("PCoA", "jaccard") 
pcoa_jaccard_sensitve_plot <- plot_ordination(phyl_sensitive_rel_strain,
                pcoa_jaccard_sensitive_rel_strain,
                color = "Treatment",
                axes = c(1,2)) +
  ggforce::geom_mark_ellipse(fill = "grey90") +
  geom_point() +
  facet_grid(~Timepoint) +
  geom_point(size = 3) +
  geom_point(size = 3, pch = 21, color = "black") +
  ggtitle(paste("Sensitive Syncom: PCoA")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(text = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        strip.background = element_rect(fill = "white"))  
```

#### Fig2

```{r}
phyl_all_strainglom <- merge_phyloseq(
              phyloseq(otu_table(syncomRandom_noChim, taxa_are_rows =F),
                  sample_data(syncomRandom_metadata),
                  tax_table(syncomRandom_tax)) %>%
               subset_samples(Rep != "Rep_1") %>%
               tax_glom("Strain"),
              phyloseq(otu_table(syncomTolerant_noChim, taxa_are_rows =F),
                  sample_data(syncomTolerant_metadata),
                  tax_table(syncomTolerant_tax)) %>%
               subset_samples(Rep != "Rep_1") %>%
               tax_glom("Strain"),
              phyloseq(otu_table(syncomMixed_noChim, taxa_are_rows =F),
                  sample_data(syncomMixed_metadata),
                  tax_table(syncomMixed_tax)) %>%
               subset_samples(Rep != "Rep_1") %>%
               tax_glom("Strain"),
              phyloseq(otu_table(syncomSensitive_noChim, taxa_are_rows =F),
                  sample_data(syncomSensitive_metadata),
                  tax_table(syncomSensitive_tax)) %>%
               subset_samples(Rep != "Rep_1") %>%
               tax_glom("Strain")
) %>% 
  tax_glom("Strain")
```


```{r}
all_jaccard_PCoA_Strain <- phyl_all_strainglom %>% 
  transform_sample_counts(function(x) x / sum(x)) %>% 
  ordinate("PCoA", "jaccard")
```

```{r}
all_syncom_jaccard_pcoa <- plot_ordination(phyl_all_strainglom, all_jaccard_PCoA_Strain, color = "Syncom") +
  geom_point(aes(color = Syncom), size =3) +
  facet_grid(Timepoint ~ fct_relevel(Treatment, c("Control","BOA","APO"))) +
  geom_point(size = 3) +
  geom_point(size = 3, pch = 21, color = "black") +
  ggforce::geom_mark_ellipse() +
  theme_bw() +
  ggthemes::scale_color_few(na.value = "grey80",
                           name = "Syncom",
                           labels = c("Random",
                                      "Tolerant",
                                      "Mixed",
                                      "Sensitive"),
                           breaks = c("Full_Random",
                                      "Reduced_Tolerant",
                                      "Reduced_Mixed",
                                      "Reduced_Sensitive")) +
    theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        axis.text = element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold")) +
  ggtitle("PCoA of all Syncoms")
```

```{r}
all_syncom_jaccard_pcoa /
(pcoa_jaccard_random_plot | pcoa_jaccard_tolerant_plot) /
(pcoa_jaccard_mixed_plot | pcoa_jaccard_sensitve_plot) +
  plot_layout(guides = "collect",
              heights = c(3,1,1)) +
  plot_annotation(tag_levels = "A") &
  theme(text=element_text(family = "NimbusMon"), strip.background = element_rect(fill = "white"))
```

### CCA with jaccard

```{r}
cca_jaccard_random_rel_strain <-  phyl_random_rel_strain %>%
  ordinate("CCA", "jaccard", formula = ~Treatment+Timepoint) 
cca_jaccard_random_plot<- plot_ordination(phyl_random_rel_strain,
                cca_jaccard_random_rel_strain,
                color = "Treatment",
                axes = c(1,2)) +
  ggforce::geom_mark_ellipse(fill = "grey90") +
  geom_point() +
  facet_grid(~Timepoint) +
  geom_point(size = 3) +
  geom_point(size = 3, pch = 21, color = "black") +
  ggtitle(paste("Random Syncom: CCA")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(text = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        strip.background = element_rect(fill = "white"))  

cca_jaccard_tolerant_rel_strain <-  phyl_tolerant_rel_strain %>%
  ordinate("CCA", "jaccard", formula = ~Treatment+Timepoint) 
cca_jaccard_tolerant_plot <- plot_ordination(phyl_tolerant_rel_strain,
                cca_jaccard_tolerant_rel_strain,
                color = "Treatment",
                axes = c(1,2)) +
  ggforce::geom_mark_ellipse(fill = "grey90") +
  geom_point() +
  facet_grid(~Timepoint) +
  geom_point(size = 3) +
  geom_point(size = 3, pch = 21, color = "black") +
  ggtitle(paste("Tolerant Syncom: CCA")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(text = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        strip.background = element_rect(fill = "white"))  

cca_jaccard_mixed_rel_strain <-  phyl_mixed_rel_strain %>%
  ordinate("CCA", "jaccard", formula = ~Treatment+Timepoint) 
cca_jaccard_mixed_plot <- plot_ordination(phyl_mixed_rel_strain,
                cca_jaccard_mixed_rel_strain,
                color = "Treatment",
                axes = c(1,2)) +
  ggforce::geom_mark_ellipse(fill = "grey90") +
  geom_point() +
  facet_grid(~Timepoint) +
  geom_point(size = 3) +
  geom_point(size = 3, pch = 21, color = "black") +
  ggtitle(paste("Mixed Syncom: CCA")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(text = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        strip.background = element_rect(fill = "white"))  

cca_jaccard_sensitive_rel_strain <-  phyl_sensitive_rel_strain %>%
  ordinate("CCA", "jaccard", formula = ~Treatment+Timepoint) 
cca_jaccard_sensitve_plot <- plot_ordination(phyl_sensitive_rel_strain,
                cca_jaccard_sensitive_rel_strain,
                color = "Treatment",
                axes = c(1,2)) +
  ggforce::geom_mark_ellipse(fill = "grey90") +
  geom_point() +
  facet_grid(~Timepoint) +
  geom_point(size = 3) +
  geom_point(size = 3, pch = 21, color = "black") +
  ggtitle(paste("Sensitive Syncom: CCA")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(text = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        strip.background = element_rect(fill = "white"))  
```

#### Fig2

```{r}
phyl_all_strainglom <- merge_phyloseq(
              phyloseq(otu_table(syncomRandom_noChim, taxa_are_rows =F),
                  sample_data(syncomRandom_metadata),
                  tax_table(syncomRandom_tax)) %>%
               subset_samples(Rep != "Rep_1") %>%
               tax_glom("Strain"),
              phyloseq(otu_table(syncomTolerant_noChim, taxa_are_rows =F),
                  sample_data(syncomTolerant_metadata),
                  tax_table(syncomTolerant_tax)) %>%
               subset_samples(Rep != "Rep_1") %>%
               tax_glom("Strain"),
              phyloseq(otu_table(syncomMixed_noChim, taxa_are_rows =F),
                  sample_data(syncomMixed_metadata),
                  tax_table(syncomMixed_tax)) %>%
               subset_samples(Rep != "Rep_1") %>%
               tax_glom("Strain"),
              phyloseq(otu_table(syncomSensitive_noChim, taxa_are_rows =F),
                  sample_data(syncomSensitive_metadata),
                  tax_table(syncomSensitive_tax)) %>%
               subset_samples(Rep != "Rep_1") %>%
               tax_glom("Strain")
) %>% 
  tax_glom("Strain")
```


```{r}
all_jaccard_cca_Strain <- phyl_all_strainglom %>% 
  transform_sample_counts(function(x) x / sum(x)) %>% 
  ordinate("CCA", "jaccard", formula = ~Syncom*Treatment*Timepoint)
```

```{r}
all_syncom_jaccard_cca <- plot_ordination(phyl_all_strainglom, all_jaccard_cca_Strain, color = "Syncom") +
  geom_point(aes(color = Syncom), size =3) +
  facet_grid(Timepoint ~ fct_relevel(Treatment, c("Control","BOA","APO"))) +
  geom_point(size = 3) +
  geom_point(size = 3, pch = 21, color = "black") +
  ggforce::geom_mark_ellipse() +
  theme_bw() +
  ggthemes::scale_color_few(na.value = "grey80",
                           name = "Syncom",
                           labels = c("Random",
                                      "Tolerant",
                                      "Mixed",
                                      "Sensitive"),
                           breaks = c("Full_Random",
                                      "Reduced_Tolerant",
                                      "Reduced_Mixed",
                                      "Reduced_Sensitive")) +
    theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        axis.text = element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold")) +
  ggtitle("CCA of all Syncoms", sub = "Syncom*Treatment*Timepoint")
```

```{r}
all_syncom_jaccard_cca /
(cca_jaccard_random_plot | cca_jaccard_tolerant_plot) /
(cca_jaccard_mixed_plot | cca_jaccard_sensitve_plot) +
  plot_layout(guides = "collect",
              heights = c(3,1,1)) +
  plot_annotation(tag_levels = "A") &
  theme(text=element_text(family = "NimbusMon"), strip.background = element_rect(fill = "white"))
```

```{r}
(cca_jaccard_random_plot | cca_jaccard_tolerant_plot) /
(cca_jaccard_mixed_plot | cca_jaccard_sensitve_plot) +
  plot_layout(guides = "collect",
              heights = c(1,1)) +
  plot_annotation(tag_levels = "A", caption = "Formula: Treatment + Timepoint") &
  theme(text=element_text(family = "NimbusMon"), strip.background = element_rect(fill = "white"))
```


## PERMANOVA

```{r}
random_bray <- phyl_random_rel_strain %>% phyloseq::distance("bray")
random_jaccard <- phyl_random_rel_strain %>% phyloseq::distance("jaccard")
random_wuni <- phyl_random_rel_strain %>% phyloseq::distance("wunifrac")
random_samples <- phyl_random_rel_strain %>% sample_data() %>% as("data.frame")
```

```{r}
vegan::adonis(random_bray ~ Timepoint + Treatment,data = random_samples )
```
```{r}
vegan::adonis(random_wuni ~ Timepoint + Treatment,data = random_samples )
```
```{r}
vegan::adonis(random_jaccard ~ Timepoint + Treatment,data = random_samples )
```
```{r}
tolerant_bray <- phyl_tolerant_rel_strain %>% phyloseq::distance("bray")
tolerant_jaccard <- phyl_tolerant_rel_strain %>% phyloseq::distance("jaccard")
tolerant_wuni <- phyl_tolerant_rel_strain %>% phyloseq::distance("wunifrac")
tolerant_samples <- phyl_tolerant_rel_strain %>% sample_data() %>% as("data.frame")
```

```{r}
vegan::adonis(tolerant_bray ~ Timepoint + Treatment,data = tolerant_samples )
```
```{r}
vegan::adonis(tolerant_jaccard ~ Timepoint + Treatment,data = tolerant_samples )
```
```{r}
vegan::adonis(tolerant_wuni ~ Timepoint + Treatment,data = tolerant_samples )
```
```{r}
mixed_bray <- phyl_mixed_rel_strain %>% phyloseq::distance("bray")
mixed_jaccard <- phyl_mixed_rel_strain %>% phyloseq::distance("jaccard")
mixed_wuni <- phyl_mixed_rel_strain %>% phyloseq::distance("wunifrac")
mixed_samples <- phyl_mixed_rel_strain %>% sample_data() %>% as("data.frame")
```

```{r}
vegan::adonis(mixed_bray ~ Timepoint + Treatment,data = mixed_samples )
```
```{r}
vegan::adonis(mixed_jaccard ~ Timepoint + Treatment,data = mixed_samples )
```
```{r}
vegan::adonis(mixed_wuni ~ Timepoint + Treatment,data = mixed_samples )
```
```{r}
sensitive_bray <- phyl_sensitive_rel_strain %>% phyloseq::distance("bray")
sensitive_jaccard <- phyl_sensitive_rel_strain %>% phyloseq::distance("jaccard")
sensitive_wuni <- phyl_sensitive_rel_strain %>% phyloseq::distance("wunifrac")
sensitive_samples <- phyl_sensitive_rel_strain %>% sample_data() %>% as("data.frame")
```

```{r}
vegan::adonis(sensitive_bray ~ Timepoint + Treatment,data = sensitive_samples )
```
```{r}
vegan::adonis(sensitive_jaccard ~ Timepoint + Treatment,data = sensitive_samples )
```
```{r}
vegan::adonis(sensitive_wuni ~ Timepoint + Treatment,data = sensitive_samples )
```

### Tab S1 PERMANOVA

```{r}
bind_rows(list(vegan::adonis(random_jaccard ~ Timepoint * Treatment, data = random_samples ) %>% 
  .$aov.tab %>% 
  as_tibble(rownames= "term") %>% 
  mutate(Syncom = "Random"),
vegan::adonis(tolerant_jaccard ~ Timepoint * Treatment, data = tolerant_samples ) %>% 
  .$aov.tab %>% 
  as_tibble(rownames= "term") %>% 
  mutate(Syncom = "Tolerant"),
vegan::adonis(mixed_jaccard ~ Timepoint * Treatment, data = mixed_samples ) %>% 
  .$aov.tab %>% 
  as_tibble(rownames= "term") %>% 
  mutate(Syncom = "Mixed"),
vegan::adonis(sensitive_jaccard ~ Timepoint * Treatment, data = sensitive_samples ) %>% 
  .$aov.tab %>% 
  as.tibble(rownames= "term") %>% 
  mutate(Syncom = "Sensitive"))) %>%
  {set_colnames(.,c(colnames(.)[1:6], "p.value", "Syncom"))} %>% 
  mutate(round(across(where(is.numeric)),4)) %>% 
  group_by(Syncom) %>% 
  gt::gt() %>% 
  gt::tab_header("Table S5. PERMANOVA", subtitle = "999 Permutations") %>%  
  gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.05),
    fn = function(x) paste(x, "*")
  ) %>% 
    gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.01),
    fn = function(x) paste(x, "*")
  ) %>% gt::tab_style(
    style = list(
      gt::cell_text(align = "left")
      ),
    locations = gt::cells_body(columns = "p.value")
  ) %>% 
  gt::tab_style(
    style = list(
      gt::cell_text(weight = "bold")
      ),
    locations = gt::cells_body(
      columns = c("term","R2","p.value"),
      rows = p.value < 0.05 )
  ) %>% 
  gt::gtsave("TabS5_permanova.html")
```

```{r}
bind_rows(list(vegan::adonis(random_jaccard ~ Timepoint * Treatment, data = random_samples ) %>% 
  .$aov.tab %>% 
  as_tibble(rownames= "term") %>% 
  mutate(Syncom = "Random"),
vegan::adonis(tolerant_jaccard ~ Timepoint * Treatment, data = tolerant_samples ) %>% 
  .$aov.tab %>% 
  as_tibble(rownames= "term") %>% 
  mutate(Syncom = "Tolerant"),
vegan::adonis(mixed_jaccard ~ Timepoint * Treatment, data = mixed_samples ) %>% 
  .$aov.tab %>% 
  as_tibble(rownames= "term") %>% 
  mutate(Syncom = "Mixed"),
vegan::adonis(sensitive_jaccard ~ Timepoint * Treatment, data = sensitive_samples ) %>% 
  .$aov.tab %>% 
  as.tibble(rownames= "term") %>% 
  mutate(Syncom = "Sensitive"))) %>%
  {set_colnames(.,c(colnames(.)[1:6], "p.value", "Syncom"))} %>% 
  mutate(round(across(where(is.numeric)),4)) %>% 
  group_by(Syncom) %>% 
  gt::gt() %>% 
#  gt::tab_header("Table S5. PERMANOVA", subtitle = "999 Permutations") %>%  
  gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.05),
    fn = function(x) paste(x, "*")
  ) %>% 
    gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.01),
    fn = function(x) paste(x, "*")
  ) %>% gt::tab_style(
    style = list(
      gt::cell_text(align = "left")
      ),
    locations = gt::cells_body(columns = "p.value")
  ) %>% 
  gt::tab_style(
    style = list(
      gt::cell_text(weight = "bold")
      ),
    locations = gt::cells_body(
      columns = c("term","R2","p.value"),
      rows = p.value < 0.05 )
  ) %>% 
  write_rds("TabS5_permanova_gt.rds")
```

### 

```{r}
vegan::adonis(tolerant_jaccard ~ Timepoint + Treatment,data = tolerant_samples ) #%>% .$coef.sites
```


```{r}
vegan::adonis(tolerant_jaccard ~ Timepoint + Treatment,data = tolerant_samples ) %>% .$coef.sites
```

```{r}
vegan::adonis(tolerant_jaccard ~ Timepoint + Treatment,data = tolerant_samples ) %>% .$coef.sites
```


## Centroid distances

```{r}
colors_centroids <- wesanderson::wes_palette("Royal1", 2, "discrete")
```


```{r}
centroid_dist_random <- vegan::betadisper(random_jaccard, paste(labels(random_jaccard) %>% str_extract("APO|BOA|DMSO"),
  labels(random_jaccard) %>% str_extract("24h|48h|72h|96h"), sep = "_")) %>% 
  vegan::scores() %>% 
  .$centroids %>% 
  as.data.frame() %>% 
  set_colnames(c("PCoA1","PCoA2")) %>% 
  rownames_to_column("Sample") %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  separate(Sample, c("Treatment", "Timepoint"), sep ="_") %>% 
  group_by(Timepoint, PC) %>% 
  mutate(Dist_from_DMSO = Distance - Distance[Treatment == "DMSO"]) %>% 
  filter(Treatment != "DMSO") %>% 
  ggplot(aes(x = Timepoint, y = abs(Distance))) +
  geom_col(aes(fill = PC, group = Timepoint), position = "dodge2") +
  facet_grid(~Treatment) +
  labs(y = "Distance from Control",
       title = "Random") +
  scale_fill_manual(values = colors_centroids) +
  theme_bw() +
      theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        text = element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold")) 
centroid_dist_random
```

```{r}
centroid_dist_tolerant <- vegan::betadisper(tolerant_jaccard, paste(labels(tolerant_jaccard) %>% str_extract("APO|BOA|DMSO"),
  labels(tolerant_jaccard) %>% str_extract("24h|48h|72h|96h"), sep = "_")) %>% 
  vegan::scores() %>% 
  .$centroids %>% 
  as.data.frame() %>% 
  set_colnames(c("PCoA1","PCoA2")) %>% 
  rownames_to_column("Sample") %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  separate(Sample, c("Treatment", "Timepoint"), sep ="_") %>% 
  group_by(Timepoint, PC) %>% 
  mutate(Dist_from_DMSO = Distance - Distance[Treatment == "DMSO"]) %>% 
  filter(Treatment != "DMSO") %>% 
  ggplot(aes(x = Timepoint, y = abs(Distance))) +
  geom_col(aes(fill = PC, group = Timepoint), position = "dodge2") +
  facet_grid(~Treatment) +
  labs(y = "Distance from Control",
       title = "Tolerant") +
  scale_fill_manual(values = colors_centroids) +
  theme_bw() +
      theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        text = element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold")) 
centroid_dist_tolerant
```

```{r}
centroid_dist_mixed <- vegan::betadisper(mixed_jaccard, paste(labels(mixed_jaccard) %>% str_extract("APO|BOA|DMSO"),
  labels(mixed_jaccard) %>% str_extract("24h|48h|72h|96h"), sep = "_")) %>% 
  vegan::scores() %>% 
  .$centroids %>% 
  as.data.frame() %>% 
  set_colnames(c("PCoA1","PCoA2")) %>% 
  rownames_to_column("Sample") %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  separate(Sample, c("Treatment", "Timepoint"), sep ="_") %>% 
  group_by(Timepoint, PC) %>% 
  mutate(Dist_from_DMSO = Distance - Distance[Treatment == "DMSO"]) %>% 
  filter(Treatment != "DMSO") %>% 
  ggplot(aes(x = Timepoint, y = abs(Distance))) +
  geom_col(aes(fill = PC, group = Timepoint), position = "dodge2") +
  facet_grid(~Treatment) +
  labs(y = "Distance from Control",
       title = "Mixed") +
  scale_fill_manual(values = colors_centroids) +
  theme_bw() +
      theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        text = element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold")) 
centroid_dist_mixed
```

```{r}
centroid_dist_sensitive <- vegan::betadisper(sensitive_jaccard, paste(labels(sensitive_jaccard) %>% str_extract("APO|BOA|DMSO"),
  labels(sensitive_jaccard) %>% str_extract("24h|48h|72h|96h"), sep = "_")) %>% 
  vegan::scores() %>% 
  .$centroids %>% 
  as.data.frame() %>% 
  set_colnames(c("PCoA1","PCoA2")) %>% 
  rownames_to_column("Sample") %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  separate(Sample, c("Treatment", "Timepoint"), sep ="_") %>% 
  group_by(Timepoint, PC) %>% 
  mutate(Dist_from_DMSO = Distance - Distance[Treatment == "DMSO"]) %>% 
  filter(Treatment != "DMSO") %>% 
  ggplot(aes(x = Timepoint, y = abs(Distance))) +
  geom_col(aes(fill = PC, group = Timepoint), position = "dodge2") +
  facet_grid(~Treatment) +
  labs(y = "Distance from Control",
       title = "Sensitive") +
  scale_fill_manual(values = colors_centroids) +
  theme_bw() +
      theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        text = element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold")) 
centroid_dist_sensitive
```

### Combined

```{r}
(centroid_dist_random + centroid_dist_tolerant) /
  (centroid_dist_mixed + centroid_dist_sensitive) +
  plot_layout(guides = 'collect')
```

### CCA Centroids

```{r}
cca_jaccard_random_rel_strain <-  phyl_random_rel_strain %>%
  ordinate("CCA", distance = "jaccard", formula = ~Timepoint*Treatment) 
cca_jaccard_tolerant_rel_strain <-  phyl_tolerant_rel_strain %>%
  ordinate("CCA", distance = "jaccard", formula = ~Timepoint*Treatment) 
cca_jaccard_mixed_rel_strain <-  phyl_mixed_rel_strain %>%
  ordinate("CCA", distance = "jaccard", formula = ~Timepoint*Treatment) 
cca_jaccard_sensitive_rel_strain <-  phyl_sensitive_rel_strain %>%
  ordinate("CCA", distance = "jaccard", formula = ~Timepoint*Treatment) 
```

```{r}
centroids_scaled <- bind_rows(
cca_jaccard_random_rel_strain %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Random") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  ,
cca_jaccard_tolerant_rel_strain %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Tolerant") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  ,
cca_jaccard_mixed_rel_strain %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Mixed") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  ,
cca_jaccard_sensitive_rel_strain %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Sensitive") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  
) %>% 
  mutate(Treatment = str_extract(Var,"BOA|APO"))
```

```{r}
centroids_scaled %>% 
  ggplot(aes(x = Treatment, y = Dist_from_Control)) +
  geom_col(aes(fill = PC, group = Var), position = "dodge2") +
  facet_grid(~Syncom) +
  labs(y = "Distance from Control") +
  scale_fill_manual(values = colors_centroids) +
  theme_bw() +
      theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        text = element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold")) 
```
```{r}
centroids_scaled %>% 
  group_by(Syncom, Treatment) %>%
  summarise(Total_dist = sum(abs(Dist_from_Control))) %>% 
  ungroup %>% 
  ggplot(aes(x = Treatment, y = Total_dist)) +
  geom_col(aes(fill = Treatment),position = "dodge2") +
  facet_grid(~Syncom) +
  labs(y = "Scaled Aggregate distance from Control") +
  scale_fill_manual(values = colors_centroids) +
  theme_bw() +
      theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        text = element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold")) 
```

```{r}
centroids_scaled %>% 
  group_by(Syncom) %>%
  summarise(Total_dist = sum(abs(Dist_from_Control))) %>% 
  ungroup %>% 
  ggplot(aes(x = Syncom, y = Total_dist)) +
  geom_col(position = "dodge2") +
  labs(y = "Scaled aggregate distance from Control") +
  scale_fill_manual(values = colors_centroids) +
  theme_bw() +
      theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        text = element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold")) 
```

### Per timepoint centroids

```{r}
centroids_random_scaled_per_timepoint <- bind_rows(
phyl_random_rel_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Random") %>% 
  mutate(Timepoint = "24h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  ,
phyl_random_rel_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Random") %>% 
  mutate(Timepoint = "48h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  ,
phyl_random_rel_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Random") %>% 
  mutate(Timepoint = "72h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  ,
phyl_random_rel_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Random") %>% 
  mutate(Timepoint = "96h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")) %>% 
  mutate(Treatment = str_extract(Var,"BOA|APO"))

centroids_tolerant_scaled_per_timepoint <- bind_rows(
phyl_tolerant_rel_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Tolerant") %>% 
  mutate(Timepoint = "24h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  ,
phyl_tolerant_rel_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Tolerant") %>% 
  mutate(Timepoint = "48h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  ,
phyl_tolerant_rel_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Tolerant") %>% 
  mutate(Timepoint = "72h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  ,
phyl_tolerant_rel_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Tolerant") %>% 
  mutate(Timepoint = "96h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")) %>% 
  mutate(Treatment = str_extract(Var,"BOA|APO"))

centroids_mixed_scaled_per_timepoint <- bind_rows(
phyl_mixed_rel_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Mixed") %>% 
  mutate(Timepoint = "24h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  ,
phyl_mixed_rel_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Mixed") %>% 
  mutate(Timepoint = "48h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  ,
phyl_mixed_rel_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Mixed") %>% 
  mutate(Timepoint = "72h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  ,
phyl_mixed_rel_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Mixed") %>% 
  mutate(Timepoint = "96h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")) %>% 
  mutate(Treatment = str_extract(Var,"BOA|APO"))

centroids_sensitive_scaled_per_timepoint <- bind_rows(
phyl_sensitive_rel_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Sensitive") %>% 
  mutate(Timepoint = "24h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  ,
phyl_sensitive_rel_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Sensitive") %>% 
  mutate(Timepoint = "48h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  ,
phyl_sensitive_rel_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Sensitive") %>% 
  mutate(Timepoint = "72h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")  ,
phyl_sensitive_rel_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  ordinate("CCA", distance = "jaccard", formula = ~Treatment)  %>% 
  scores(scaling = -3) %>%
  .$centroids %>%
  as.data.frame() %>% 
  rownames_to_column("Var") %>% 
  mutate(Syncom = "Sensitive") %>% 
  mutate(Timepoint = "96h") %>% 
  filter(str_detect(Var, "Treatment")) %>% 
  pivot_longer(2:3, names_to = "PC", values_to = "Distance") %>% 
  mutate(Dist_from_Control = Distance - Distance[Var == "TreatmentControl"]) %>% 
  filter(Var != "TreatmentControl")) %>% 
  mutate(Treatment = str_extract(Var,"BOA|APO"))
```

```{r}
bind_rows(centroids_random_scaled_per_timepoint,
          centroids_tolerant_scaled_per_timepoint,
          centroids_mixed_scaled_per_timepoint,
          centroids_sensitive_scaled_per_timepoint) %>% 
  group_by(Syncom, Timepoint, Treatment) %>%
  summarise(Total_dist = sum(abs(Dist_from_Control))) %>% 
  ungroup %>% 
  ggplot(aes(x = Timepoint, y = Total_dist)) +
  geom_col(aes(fill = Treatment), position = "dodge2") +
  facet_grid(~fct_relevel(Syncom, c("Random", "Tolerant", "Mixed","Sensitive"))) +
  labs(y = "Scaled centroid distance from control") +
  ggthemes::scale_fill_few() +
  theme_bw() +
      theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        text = element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold")) 
```

```{r}
lm_centroids <- bind_rows(centroids_random_scaled_per_timepoint,
          centroids_tolerant_scaled_per_timepoint,
          centroids_mixed_scaled_per_timepoint,
          centroids_sensitive_scaled_per_timepoint) %>% 
  #group_by(Syncom) %>% 
  {lm(abs(Dist_from_Control) ~ Syncom*Treatment, data = .)}
emmeans::emmeans(lm_centroids,~Syncom|Treatment) %>% 
  #summary %>% 
  pwpp() +
  theme_bw() +
  theme(text = element_text(family = "NimbusMon"))
```


# Fig S3

## AUC vs relative Abundance

```{r}
strain_AUC <- AUC_emmeans %>%
  filter(Treat.x %in% c("Control","50uM_APO","100uM_BOA")) %>%
  mutate(Treatment = case_when(Treat.x == "Control" ~ Treat.x,
                               Treat.x == "50uM_APO" ~ "APO",
                               Treat.x == "100uM_BOA" ~ "BOA")) %>% 
  dplyr::select(Strain, Treatment, AUC, estimate) %>%
  group_by(Strain,Treatment) %>%
  summarize(mean_AUC = mean(AUC, na.rm = T),
            mean_rel_AUC = mean(estimate, na.rm = T)) %>%
  ungroup  

strain_relabund <- bind_rows(list(
  phyl_mixed_rel_strain %>% psmelt(),
  phyl_random_rel_strain %>% psmelt(),
  phyl_tolerant_rel_strain %>% psmelt(),
  phyl_sensitive_rel_strain %>% psmelt())) %>%
  dplyr::select(Strain, Genus, Abundance, Treatment, Syncom) %>% 
  separate(Syncom, into= c(NA, "Syncom")) %>% 
  group_by(Strain, Genus,Treatment, Syncom) %>%
  summarize(mean_rel_abund = mean(Abundance, na.rm =T )) %>% 
  ungroup()

strain_relabund_per_timepoint <- bind_rows(list(
  phyl_mixed_rel_strain %>% psmelt(),
  phyl_random_rel_strain %>% psmelt(),
  phyl_tolerant_rel_strain %>% psmelt(),
  phyl_sensitive_rel_strain %>% psmelt())) %>%
  dplyr::select(Strain, Genus, Abundance, Treatment, Timepoint, Syncom) %>% 
  separate(Syncom, into= c(NA, "Syncom")) %>% 
  group_by(Strain, Genus, Treatment, Timepoint, Syncom) %>% 
  summarize(mean_rel_abund = mean(Abundance, na.rm =T )) %>% 
  ungroup()
```

### Figure

```{r}
left_join(strain_AUC, strain_relabund,  by = c("Strain", "Treatment")) %>% 
  filter(!is.na(Treatment), !is.na(Syncom)) %>% 
  ggplot(aes(x = mean_AUC, y = mean_rel_abund, color = Treatment, shape = Syncom)) +
  geom_point() +
  ggthemes::scale_color_few() +
  theme_bw(base_family = "NimbusMon") +
  xlab("Area under the curve") +
  ylab("Relative abundance") +
  ggtitle("Figure S3: AUC vs Relative abundance") +
  NULL
```

Only for strains that are found in communities:

```{r}
left_join(strain_AUC, strain_relabund,  by = c("Strain", "Treatment")) %>% 
  filter(!is.na(Treatment), !is.na(Syncom), !is.na(mean_rel_abund), mean_rel_abund > 0) %>%
  ggplot(aes(x = mean_AUC, y = log10(mean_rel_abund), color = Syncom)) +
  geom_point(colour = "black", size = 2) +
  geom_point() +
  facet_wrap(~Treatment) +
  scale_color_manual(values = syncom_colors) +
  theme_bw(base_family = "NimbusMon") +
  xlab("Area under the curve") +
  ylab("Relative abundance") +
  ggtitle("Figure S3: AUC vs Relative abundance") +
  NULL
```

```{r}
left_join(strain_AUC, strain_relabund,  by = c("Strain", "Treatment")) %>% 
  mutate(Syncom = fct_relevel(Syncom, c("Random","Tolerant","Mixed","Sensitive"))) %>% 
  filter(!is.na(Treatment), !is.na(Syncom), !is.na(mean_rel_abund), mean_rel_abund > 0) %>%
  ggplot(aes(x = mean_AUC, y = log10(mean_rel_abund), color = Syncom)) +
  geom_point(colour = "black", size = 2) +
  geom_point() +
  facet_grid(Syncom~Treatment) +
  scale_color_manual(values = syncom_colors) +
  theme_bw(base_family = "NimbusMon") +
  xlab("Area under the curve") +
  ylab("log10(rel. abundance)") +
  ggtitle("AUC vs Relative abundance") +
  NULL
```




```{r}
left_join(strain_AUC, strain_relabund_per_timepoint,  by = c("Strain", "Treatment")) %>% 
  filter(!is.na(Treatment), !is.na(Syncom), !is.na(mean_rel_abund), mean_rel_abund > 0) %>%
  ggplot(aes(x = mean_AUC, y = log10(mean_rel_abund), color = Syncom)) +
  geom_point(colour = "black", size = 2) +
  geom_point() +
  facet_grid(Timepoint~Treatment) +
  scale_color_manual(values = syncom_colors) +
  theme_bw(base_family = "NimbusMon") +
  xlab("Area under the curve") +
  ylab("log10(rel. abundance)") +
  ggtitle("Figure S3: AUC vs Relative abundance") +
  NULL
```

## Delta 

```{r}
strain_AUC_deltas <- strain_AUC %>% 
  group_by(Strain) %>% 
  mutate(delta_AUC = mean_AUC - mean_AUC[Treatment == "Control"])
strain_relabund_per_timepoint_deltas <- 
  strain_relabund_per_timepoint %>% 
  droplevels() %>% 
  group_by(Strain, Timepoint, Syncom) %>%
  mutate(delta_rel_abundance = mean_rel_abund - mean_rel_abund[Treatment == "Control"],
         norm_d_rel_abundance = delta_rel_abundance / mean_rel_abund[Treatment == "Control"])

left_join(strain_AUC_deltas, strain_relabund_per_timepoint_deltas,  by = c("Strain", "Treatment")) %>% 
  filter(!is.na(Treatment), !is.na(Syncom), !is.na(mean_rel_abund), Treatment != "Control", mean_rel_abund != 0) %>%
  ggplot(aes(x = delta_AUC, y = delta_rel_abundance, color = Syncom)) +
  geom_vline(aes(xintercept = 0)) +
  geom_hline(aes(yintercept = 0)) +
  geom_point(colour = "black", size = 2) +
  geom_point() +
  facet_wrap(Timepoint~Treatment, scales = "free", ncol = 2) +
  scale_color_manual(values = syncom_colors) +
  theme_bw(base_family = "NimbusMon") +
  xlab(expression(paste(Delta, " Area under the curve"))) +
  ylab(expression(paste(Delta, " log10(rel. abundance)"))) +
  ggtitle("Figure S3: AUC vs Relative abundance compared to control") +
  NULL
```

### Delta all avg timepoints

```{r}
strain_relabund_delta <- strain_relabund %>% 
  droplevels() %>% 
  group_by(Strain, Syncom) %>%
  mutate(delta_rel_abundance = mean_rel_abund - mean_rel_abund[Treatment == "Control"],
         norm_d_rel_abundance = delta_rel_abundance / mean_rel_abund[Treatment == "Control"],
         ratio_rel_abundance = mean_rel_abund / mean_rel_abund[Treatment == "Control"],) %>% 
    group_by(Strain, Syncom, Treatment) %>%
  mutate(rel_d_abundance = delta_rel_abundance / mean_rel_abund)

left_join(strain_AUC_deltas, strain_relabund_delta,  by = c("Strain", "Treatment")) %>% 
  filter(!is.na(Treatment), !is.na(Syncom), !is.na(mean_rel_abund), Treatment != "Control", mean_rel_abund != 0) %>%
  ggplot(aes(x = delta_AUC, y = delta_rel_abundance, color = Syncom)) +
  geom_vline(aes(xintercept = 0)) +
  geom_hline(aes(yintercept = 0)) +
  geom_point(colour = "black", size = 3.5) +
  geom_point(size = 3) +
  facet_wrap(~Treatment, scales = "free", ncol = 2) +
  scale_color_manual(values = syncom_colors) +
  theme_bw(base_family = "NimbusMon") +
  xlab(expression(paste(Delta, " Area under the curve"))) +
  ylab(expression(paste(Delta, " log10(rel. abundance)"))) +
  ggtitle("Growth and abundance changes by treatment") +
  NULL
```

```{r}
treat_specific_strains <- strain_relabund_delta %>%
  filter(is.infinite(norm_d_rel_abundance) | is.nan(norm_d_rel_abundance)) %>%
  group_by(Strain) %>% 
  mutate(Not_in_ctrl_but = case_when(mean_rel_abund > 0 ~ Treatment,
                                     TRUE~"NA" )) %>%
  filter(Not_in_ctrl_but != "NA")
```


```{r}
(left_join(strain_AUC, strain_relabund,  by = c("Strain", "Treatment")) %>% 
  filter(!is.na(Treatment), !is.na(Syncom), !is.na(mean_rel_abund), mean_rel_abund > 0) %>%
  ggplot(aes(x = mean_AUC, y = log10(mean_rel_abund), color = Syncom)) +
  geom_point(colour = "black", size = 3.5) +
  geom_point(size = 3) +
  facet_wrap(~Treatment)  +
  scale_color_manual(values = c(syncom_colors) )+
  theme_bw(base_family = "NimbusMon") +
  xlab("Area under the curve") +
  ylab("log10(rel. abundance)") +
  ggtitle("AUC vs Relative abundance") +
  NULL) /
(left_join(strain_AUC_deltas, strain_relabund_delta,  by = c("Strain", "Treatment")) %>% 
  filter(!is.na(Treatment),
         !is.na(Syncom),
         !is.na(mean_rel_abund),
         Treatment != "Control",
         mean_rel_abund != 0) %>%
  ggplot(aes(x = delta_AUC, y = delta_rel_abundance, color = Syncom)) +
  geom_vline(aes(xintercept = 0)) +
  geom_hline(aes(yintercept = 0)) +
  geom_point(colour = "black", size = 3.5) +
  geom_point(size = 3) +
  scale_color_manual(values = syncom_colors) +
  facet_wrap(~Treatment, scales = "free", ncol = 2) +
  theme_bw(base_family = "NimbusMon") +
  xlab(expression(paste(Delta, " Area under the curve"))) +
  ylab(expression(paste(Delta, " rel. abundance"))) +
  ggtitle("Growth and abundance changes by treatment") +
  NULL) +
  plot_layout(guides = 'collect')
```

#### Fig2 E

```{r}
left_join(strain_AUC_deltas, strain_relabund_delta,  by = c("Strain", "Treatment")) %>% 
  filter(!is.na(Treatment),
         !is.na(Syncom),
         !is.na(mean_rel_abund),
         Treatment != "Control")  %>% 
  ggplot(aes(x = delta_AUC, y = ratio_rel_abundance, color = Treatment)) +
  geom_vline(aes(xintercept = 0)) +
  geom_hline(aes(yintercept = 1)) +
  geom_point(colour = "black", size = 3.5, alpha = 0.7) +
  geom_point(size = 3, alpha = 0.7) +
  ggthemes::scale_color_few() +
  #scale_color_manual(values = syncom_colors)+
  facet_wrap(fct_relevel(Syncom, c("Random", "Tolerant", "Mixed","Sensitive"))~., ncol = 2,scales = "free_y") +
  #lims(y = c(-3.2,3.1)) +
  #scale_y_continuous(labels = c("Inf",2,1,0,-1, 2,"-Inf"), breaks = c(3,2,1,0,-1,-2,-3)) +
  theme_bw(base_family = "NimbusMon") +
  xlab(expression(paste(Delta, " Area under the curve (Treatment - Control)"))) +
  ylab(expression(paste("ratio rel. abundance (Treatment / Control)"))) +
  ggtitle("Growth and abundance changes by treatment") +
  theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        text = element_text(family = "NimbusMon"),
        strip.background = element_blank(),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold")) 
```

Changes in AUC and changes in rela abundance are not correlated

```{r}
left_join(strain_AUC_deltas, strain_relabund_delta,  by = c("Strain", "Treatment")) %>% 
  filter(!is.na(Treatment),
         !is.na(Syncom),
         !is.na(mean_rel_abund),
         Treatment != "Control",
         !is.na(mean_rel_AUC),
         !is.na(ratio_rel_abundance) ,
         !is.infinite(mean_rel_AUC),
         !is.infinite(ratio_rel_abundance)) %>% 
  #.$ratio_rel_abundance
  split(interaction(.$Syncom, .$Treatment)) %>% 
  map(~cor.test(x=.x$mean_rel_AUC, y=.x$ratio_rel_abundance, method = "pearson"))
```


```{r}
strain_relabund_delta  %>% 
  filter(Treatment != "Control") %>% 
  pivot_wider(c("Strain","Syncom"), names_from = c("Treatment"),values_from = ratio_rel_abundance) %>% 
  ggplot(aes(x = APO, y = BOA, color = Syncom)) +
  geom_vline(aes(xintercept = 0)) +
  geom_hline(aes(yintercept = 0)) +
  geom_point(colour = "black", size = 3.5, alpha = 0.4) +
  geom_point(size = 3, alpha = .4) +
  scale_color_manual(values = syncom_colors)+
  facet_wrap(fct_relevel(Syncom, c("Random", "Tolerant", "Mixed","Sensitive"))~., ncol = 2) +
  #lims(y = c(-3.2,3.1)) +
  #scale_y_continuous(labels = c("Inf",2,1,0,-1, 2,"-Inf"), breaks = c(3,2,1,0,-1,-2,-3)) +
  theme_bw(base_family = "NimbusMon") +
  xlab(expression(paste("Ratio abdundances APO / Control"))) +
  ylab(expression(paste("Ratio abundances BOA / Control"))) +
  ggtitle("Growth and abundance changes by treatment") +
  NULL
```

```{r}
left_join(strain_AUC_deltas, strain_relabund_delta,  by = c("Strain", "Treatment")) %>% 
  filter(!is.na(Treatment),
         !is.na(Syncom),
         !is.na(mean_rel_abund),
         Treatment != "Control")  %>% 
  ggplot(aes(x = delta_AUC, y = ratio_rel_abundance, color = Syncom, shape = Treatment)) +
  geom_vline(aes(xintercept = 0)) +
  geom_hline(aes(yintercept = 1)) +
  geom_point(colour = "black", size = 3.5) +
  geom_point(size = 3) +
  scale_color_manual(values = syncom_colors)+
  facet_wrap(Genus~.,scales = "free_y") +
  #lims(y = c(-3.2,3.1)) +
  #scale_y_continuous(labels = c("Inf",2,1,0,-1, 2,"-Inf"), breaks = c(3,2,1,0,-1,-2,-3)) +
  theme_bw(base_family = "NimbusMon") +
  xlab(expression(paste(Delta, " Area under the curve"))) +
  ylab(expression(paste("ratio rel. abundance"))) +
  ggtitle("Growth and abundance changes by treatment") +
  NULL
```

```{r}
(left_join(strain_AUC, strain_relabund,  by = c("Strain", "Treatment")) %>% 
  filter(!is.na(Treatment), !is.na(Syncom), !is.na(mean_rel_abund), mean_rel_abund > 0) %>%
  ggplot(aes(x = mean_AUC, y = log10(mean_rel_abund), color = Syncom)) +
  geom_point(colour = "black", size = 3.5) +
  geom_point(size = 3) +
  facet_wrap(~Treatment) +
  scale_color_manual(values = syncom_colors) +
  theme_bw(base_family = "NimbusMon") +
  xlab("Area under the curve") +
  ylab("log10(rel. abundance)") +
  ggtitle("AUC vs Relative abundance") +
  NULL) /
(left_join(strain_AUC_deltas, strain_relabund_delta,  by = c("Strain", "Treatment")) %>% 
  filter(!is.na(Treatment),
         !is.na(Syncom),
         !is.na(mean_rel_abund),
         Treatment != "Control",
         !is.nan(norm_d_rel_abundance),
         !is.infinite(norm_d_rel_abundance)
         ) %>%
  ggplot(aes(x = delta_AUC, y = norm_d_rel_abundance, color = Syncom)) +
  geom_vline(aes(xintercept = 0)) +
  geom_hline(aes(yintercept = 0)) +
  geom_point(colour = "black", size = 3.5) +
  geom_point(size = 3) +
  facet_wrap(~Treatment, scales = "free", ncol = 2) +
  scale_color_manual(values = syncom_colors) +
  theme_bw(base_family = "NimbusMon") +
  xlab(expression(paste(Delta, " Area under the curve"))) +
  ylab(expression(paste("normalized\n",Delta, " rel. abundance"))) +
  ggtitle("Growth and abundance changes by treatment") +
  NULL) +
  plot_layout(guides = 'collect')
```


```{r}
left_join(strain_AUC, strain_relabund_per_timepoint,  by = c("Strain", "Treatment")) %>% 
  filter(!is.na(Treatment), !is.na(Syncom), !is.na(mean_rel_abund), mean_rel_abund > 0) %>%
  ggplot(aes(x = mean_rel_AUC, y = log10(mean_rel_abund), color = Syncom), alpha = 0.8) +
  geom_point(colour = "black", size = 2) +
  geom_point() +
  facet_grid(Timepoint~Treatment) +
  scale_color_manual(values = syncom_colors) +
  theme_bw(base_family = "NimbusMon") +
  xlab("relative area under the curve") +
  ylab("log10(rel. abundance)") +
  ggtitle("Figure S3: AUC vs Relative abundance") +
  NULL
```


```{r}
left_join(strain_AUC, strain_relabund_per_timepoint,  by = c("Strain", "Treatment")) %>% 
  filter(!is.na(Treatment), !is.na(Syncom), !is.na(mean_rel_abund), mean_rel_abund > 0) %>%
  ggplot(aes(x = mean_AUC, y = log10(mean_rel_abund), color = Timepoint, shape = Timepoint)) +
  geom_point(colour = "black", size = 2) +
  geom_point() +
  facet_grid(Syncom~Treatment) +
  ggthemes::scale_color_colorblind() +
  theme_bw(base_family = "NimbusMon") +
  xlab("Area under the curve") +
  ylab("log10(rel. abundance)") +
  ggtitle("Figure S3: AUC vs Relative abundance") +
  NULL
```

# Alpha Diversity 

## Observed

### Plots

```{r}
observed_random <- phyl_random_glom_strain %>% 
  phyloseq::estimate_richness(measures = "Observed") %>% 
  rownames_to_column("sample") %>% 
  separate(sample,
           c("Type", "Assembly","Treatment", NA, NA, "Rep", "Timepoint"),
           sep = "_") %>% 
  mutate(Treatment = case_when(Treatment == "DMSO" ~ "Control",
                               TRUE ~ Treatment)) %>% 
  mutate(Syncom = paste(Type, Assembly, sep = "_"))

observed_random_plot <- observed_random %>% 
  ggplot(aes(x = Treatment, y = Observed, color = Treatment)) +
  geom_boxplot() +
  facet_grid(~Timepoint) +
  geom_point() +
  lims(y = c(0,15.5)) +
  ggtitle(paste("Random Syncom")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

observed_tolerant <- phyl_tolerant_glom_strain %>% 
  phyloseq::estimate_richness(measures = "Observed") %>% 
  rownames_to_column("sample") %>% 
  separate(sample,
           c("Type", "Assembly","Treatment", NA, NA, "Rep", "Timepoint"),
           sep = "_") %>%
  mutate(Treatment = case_when(Treatment == "DMSO" ~ "Control",
                               TRUE ~ Treatment)) %>% 
  mutate(Syncom = paste(Type, Assembly, sep = "_")) 

observed_tolerant_plot <- observed_tolerant %>% 
  ggplot(aes(x = Treatment, y = Observed, color = Treatment)) +
  geom_boxplot() +
  facet_grid(~Timepoint) +
  geom_point() +
  lims(y = c(0,15.5)) +
  ggtitle(paste("Tolerant Syncom")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

observed_mixed <- phyl_mixed_glom_strain %>% 
  phyloseq::estimate_richness(measures = "Observed") %>% 
  rownames_to_column("sample") %>% 
  separate(sample,
           c("Type", "Assembly","Treatment", NA, NA, "Rep", "Timepoint"),
           sep = "_") %>% 
  mutate(Treatment = case_when(Treatment == "DMSO" ~ "Control",
                               TRUE ~ Treatment)) %>% 
  mutate(Syncom = paste(Type, Assembly, sep = "_")) 

observed_mixed_plot <- observed_mixed %>% 
  ggplot(aes(x = Treatment, y = Observed, color = Treatment)) +
  geom_boxplot() +
  facet_grid(~Timepoint) +
  geom_point() +
  lims(y = c(0,15.5)) +
  ggtitle(paste("Mixed Syncom")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

observed_sensitive <- phyl_sensitive_glom_strain %>% 
  phyloseq::estimate_richness(measures = "Observed") %>% 
  rownames_to_column("sample") %>% 
  separate(sample,
           c("Type", "Assembly","Treatment", NA, NA, "Rep", "Timepoint"),
           sep = "_") %>% 
  mutate(Treatment = case_when(Treatment == "DMSO" ~ "Control",
                               TRUE ~ Treatment)) %>% 
  mutate(Syncom = paste(Type, Assembly, sep = "_")) 

observed_sensitive_plot <- observed_sensitive %>% 
  ggplot(aes(x = Treatment, y = Observed, color = Treatment)) +
  geom_boxplot() +
  facet_grid(~Timepoint) +
  geom_point() +
  lims(y = c(0,15.5)) +
  ggtitle(paste("Sensitive Syncom")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
```

#### Fig S1


```{r}
FigS1 <- ((observed_random_plot | observed_tolerant_plot ) / 
   (observed_mixed_plot |observed_sensitive_plot ) ) +
  plot_annotation(title = "Figure S1: Number of observed Genera", tag_levels = "A") +
  plot_layout(guides = "collect") &
  theme(axis.title.y = element_blank(),
        legend.position = "bottom",
        text = element_text(family = "NimbusMon")) 
```

```{r}
FigS1
```


### AOV

```{r}
observed_aov <- bind_rows(list(
  observed_random %>% 
  {lm(Observed ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Random"),
  observed_tolerant %>% 
  {lm(Observed ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Tolerant"),
  observed_mixed %>% 
  {lm(Observed ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Mixed"),
  observed_sensitive %>% 
  {lm(Observed ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Sensitive")))
```

```{r}
observed_aov %>% write_rds("rds/observed_aov.rds")
```

#### Tab S3


```{r}
observed_aov %>% 
  group_by(Syncom) %>% 
  gt::gt() %>% 
  gt::tab_header("Table S3. ANOVA: Observed Diversity") %>%  
  gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.05),
    fn = function(x) paste(x, "*")
  ) %>% 
    gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.01),
    fn = function(x) paste(x, "*")
  ) %>% gt::tab_style(
    style = list(
      gt::cell_text(align = "left")
      ),
    locations = gt::cells_body(columns = "p.value")
  ) %>% 
  gt::tab_style(
    style = list(
      gt::cell_text(weight = "bold")
      ),
    locations = gt::cells_body(
      columns = c("term","p.value"),
      rows = p.value < 0.05 )
  ) 
```
```{r}
observed_aov %>% 
  group_by(Syncom) %>% 
  gt::gt() %>% 
  gt::tab_header("Table S3. ANOVA: Observed Diversity") %>%  
  gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.05),
    fn = function(x) paste(x, "*")
  ) %>% 
    gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.01),
    fn = function(x) paste(x, "*")
  ) %>% gt::tab_style(
    style = list(
      gt::cell_text(align = "left")
      ),
    locations = gt::cells_body(columns = "p.value")
  ) %>% 
  gt::tab_style(
    style = list(
      gt::cell_text(weight = "bold")
      ),
    locations = gt::cells_body(
      columns = c("term","p.value"),
      rows = p.value < 0.05 )
  ) %>% 
  gt::gtsave("TabS1_observed_aov.html")
```
```{r}
observed_aov %>% 
  group_by(Syncom) %>% 
  gt::gt() %>% 
  gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.05),
    fn = function(x) paste(x, "*")
  ) %>% 
    gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.01),
    fn = function(x) paste(x, "*")
  ) %>% gt::tab_style(
    style = list(
      gt::cell_text(align = "left")
      ),
    locations = gt::cells_body(columns = "p.value")
  ) %>% 
  gt::tab_style(
    style = list(
      gt::cell_text(weight = "bold")
      ),
    locations = gt::cells_body(
      columns = c("term","p.value"),
      rows = p.value < 0.05 )
  ) %>% 
  write_rds("TabS1_gt.rds")
```

### Pairwise CLD

```{r}
observed_all_cld <- bind_rows(list(
observed_random %>% 
  {lm(Observed ~ Treatment*Timepoint, data = .)} %>% 
  emmeans::emmeans( ~ Treatment, by = "Timepoint") %>% 
  emmeans::CLD(Letters = letters) %>%
  broom::tidy() %>% 
  {set_colnames(., c(colnames(.)[1:2],
                    "estimate",
                    "SE",
                    "Conf.lower",
                    "Conf.upper",
                    "Group"))} %>% 
  # Drop SE column since the model SE is not so interesting
    dplyr::select(-SE) %>% 
  mutate(Syncom = "Random"),
observed_tolerant %>% 
  {lm(Observed ~ Treatment*Timepoint, data = .)} %>% 
  emmeans::emmeans( ~ Treatment, by = "Timepoint") %>% 
  emmeans::CLD(Letters = letters) %>%
  broom::tidy() %>% 
  {set_colnames(., c(colnames(.)[1:2],
                    "estimate",
                    "SE",
                    "Conf.lower",
                    "Conf.upper",
                    "Group"))} %>% 
  # Drop SE column since the model SE is not so interesting
    dplyr::select(-SE) %>% 
  mutate(Syncom = "Tolerant"),
observed_mixed %>% 
  {lm(Observed ~ Treatment*Timepoint, data = .)} %>% 
  emmeans::emmeans( ~ Treatment, by = "Timepoint") %>% 
  emmeans::CLD(Letters = letters) %>%
  broom::tidy() %>% 
  {set_colnames(., c(colnames(.)[1:2],
                    "estimate",
                    "SE",
                    "Conf.lower",
                    "Conf.upper",
                    "Group"))} %>% 
  # Drop SE column since the model SE is not so interesting
    dplyr::select(-SE) %>% 
  mutate(Syncom = "Mixed"),
observed_sensitive %>% 
  {lm(Observed ~ Treatment*Timepoint, data = .)} %>% 
  emmeans::emmeans( ~ Treatment, by = "Timepoint") %>% 
  emmeans::CLD(Letters = letters) %>%
  broom::tidy() %>% 
  {set_colnames(., c(colnames(.)[1:2],
                    "estimate",
                    "SE",
                    "Conf.lower",
                    "Conf.upper",
                    "Group"))} %>% 
  # Drop SE column since the model SE is not so interesting
    dplyr::select(-SE) %>% 
  mutate(Syncom = "Sensitive"))) %>% 
  mutate(Group = str_extract(Group, "[a-z]+")) %>% 
  mutate("95% CI" = paste0("[", 
                           round(as.numeric(Conf.lower), 3),
                           " - ",
                           round(as.numeric(Conf.upper), 3),
                           "]")) %>% 
  dplyr::select(Syncom, Timepoint, Treatment, estimate, `95% CI`, Group)
```

#### Tab S4

```{r}
observed_all_cld %>% 
  mutate(estimate = round(estimate, 3)) %>% 
  group_by(Syncom, Timepoint) %>% 
  gt::gt()  %>% 
  gt::tab_header("Table S4. Observed diversity means and pairwise comparisons") %>% 
  gt::tab_style(style = gt::cell_fill(color = "#cbe0ff"),
      locations = gt::cells_body(
      columns = c("Group"),
      rows = Group == "a" )) %>% 
  gt::tab_style(style = gt::cell_fill(color = "#ddc3d0"),
      locations = gt::cells_body(
      columns = c("Group"),
      rows = Group == "b")) %>%   
  gt::tab_footnote(
    footnote = "Different letters indicate significant differences within one Syncom / Timepoint combination (alpha = 0.05), Tukey adjusted",
    locations = gt::cells_column_labels("Group"))
```
```{r}
observed_all_cld %>% 
  mutate(estimate = round(estimate, 3)) %>% 
  group_by(Syncom, Timepoint) %>% 
  gt::gt()  %>% 
  gt::tab_header("Table S4. Observed diversity means and pairwise comparisons") %>% 
  gt::tab_style(style = gt::cell_fill(color = "#cbe0ff"),
      locations = gt::cells_body(
      columns = c("Group"),
      rows = Group == "a" )) %>% 
  gt::tab_style(style = gt::cell_fill(color = "#ddc3d0"),
      locations = gt::cells_body(
      columns = c("Group"),
      rows = Group == "b")) %>%   
  gt::tab_footnote(
    footnote = "Different letters indicate significant differences within one Syncom / Timepoint combination (alpha = 0.05), Tukey adjusted",
    locations = gt::cells_column_labels("Group")) %>% 
  gt::gtsave("TabS4_observed_pairwise_cld.html")
```

```{r}
observed_all_cld %>% 
  mutate(estimate = round(estimate, 3)) %>% 
  group_by(Syncom, Timepoint) %>% 
  gt::gt()  %>% 
  gt::tab_style(style = gt::cell_fill(color = "#cbe0ff"),
      locations = gt::cells_body(
      columns = c("Group"),
      rows = Group == "a" )) %>% 
  gt::tab_style(style = gt::cell_fill(color = "#ddc3d0"),
      locations = gt::cells_body(
      columns = c("Group"),
      rows = Group == "b")) %>%   
  gt::tab_footnote(
    footnote = "Different letters indicate significant differences within one Syncom / Timepoint combination (alpha = 0.05), Tukey adjusted",
    locations = gt::cells_column_labels("Group")) %>% 
  write_rds("TabS2_gt.rds")
```

## Shannon

### Plots

```{r}
## Random

shannon_random <- phyl_random_glom_strain %>% 
  phyloseq::estimate_richness(measures = "Shannon") %>% 
  rownames_to_column("sample") %>% 
  separate(sample,
           c("Type", "Assembly","Treatment", NA, NA, "Rep", "Timepoint"),
           sep = "_") %>% 
  mutate(Treatment = case_when(Treatment == "DMSO" ~ "Control",
                               TRUE ~ Treatment)) %>% 
  mutate(Syncom = paste(Type, Assembly, sep = "_"))

shannon_random_plot <- shannon_random %>% 
  ggplot(aes(x = Treatment, y = Shannon, color = Treatment)) +
  geom_boxplot() +
  facet_grid(~Timepoint) +
  geom_point() +
  lims(y = c(0,1.55)) +
  ggtitle(paste("Random Syncom")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

## Tolerant

shannon_tolerant <- phyl_tolerant_glom_strain %>% 
  phyloseq::estimate_richness(measures = "Shannon") %>% 
  rownames_to_column("sample") %>% 
  separate(sample,
           c("Type", "Assembly","Treatment", NA, NA, "Rep", "Timepoint"),
           sep = "_") %>% 
  mutate(Treatment = case_when(Treatment == "DMSO" ~ "Control",
                               TRUE ~ Treatment)) %>% 
  mutate(Syncom = paste(Type, Assembly, sep = "_")) 


shannon_tolerant_plot <- shannon_tolerant %>% 
  ggplot(aes(x = Treatment, y = Shannon, color = Treatment)) +
  geom_boxplot() +
  facet_grid(~Timepoint) +
  geom_point() +
  lims(y = c(0,1.55)) +
  ggtitle(paste("Tolerant Syncom")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

## Mixed

shannon_mixed <- phyl_mixed_glom_strain %>% 
  phyloseq::estimate_richness(measures = "Shannon") %>% 
  rownames_to_column("sample") %>% 
  separate(sample,
           c("Type", "Assembly","Treatment", NA, NA, "Rep", "Timepoint"),
           sep = "_") %>% 
  mutate(Treatment = case_when(Treatment == "DMSO" ~ "Control",
                               TRUE ~ Treatment)) %>% 
  mutate(Syncom = paste(Type, Assembly, sep = "_"))

shannon_mixed_plot <- shannon_mixed %>% 
  ggplot(aes(x = Treatment, y = Shannon, color = Treatment)) +
  geom_boxplot() +
  facet_grid(~Timepoint) +
  geom_point() +
  lims(y = c(0,1.55)) +
  ggtitle(paste("Mixed Syncom")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

## Sensitive

shannon_sensitive <- phyl_sensitive_glom_strain %>% 
  phyloseq::estimate_richness(measures = "Shannon") %>% 
  rownames_to_column("sample") %>% 
  separate(sample,
           c("Type", "Assembly","Treatment", NA, NA, "Rep", "Timepoint"),
           sep = "_") %>% 
  mutate(Treatment = case_when(Treatment == "DMSO" ~ "Control",
                               TRUE ~ Treatment)) %>% 
  mutate(Syncom = paste(Type, Assembly, sep = "_"))

shannon_sensitive_plot <- shannon_sensitive %>% 
  ggplot(aes(x = Treatment, y = Shannon, color = Treatment)) +
  geom_boxplot() +
  facet_grid(~Timepoint) +
  geom_point() +
  lims(y = c(0,1.55)) +
  ggtitle(paste("Sensitive Syncom")) +
  ggthemes::scale_color_few() +
  theme_bw() +
  theme(plot.title = element_text(family = "NimbusMon"),
        plot.subtitle =  element_text(family = "NimbusMon"),
        axis.title = element_text(family = "NimbusMon"),
        strip.text = element_text(family = "NimbusMon",face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
```

Phyloseq raises a warning regarding lack of singletons. Shannon diversity does rely on low-abundance species, since these communities are in-vitro, singletons are not really expected.

#### Fig S2

```{r}
FigS2 <- ((shannon_random_plot | shannon_tolerant_plot) /
  ( shannon_mixed_plot | shannon_sensitive_plot ) ) +
  plot_annotation(title = "Figure S2: Shannon diversity indeces", tag_levels = "A") +
  plot_layout(guides = "collect") &
  theme(axis.title.y = element_blank(),
        legend.position = "bottom",
        text = element_text(family = "NimbusMon")) 
```

```{r}
FigS2
```


### AOV

```{r}
bind_rows(list(shannon_random %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Random"),
  shannon_tolerant %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Tolerant"),
  shannon_mixed %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Mixed"),
  shannon_sensitive %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Sensitive"))) %>% 
  group_by(Syncom) %>% 
  gt::gt() %>% 
  gt::tab_header("Table S5. ANOVA: Shannon Diversity") %>%  
  gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.05),
    fn = function(x) paste(x, "*")
  ) %>% 
    gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.01),
    fn = function(x) paste(x, "*")
  ) %>% gt::tab_style(
    style = list(
      gt::cell_text(align = "left")
      ),
    locations = gt::cells_body(columns = "p.value")
  ) %>% 
  gt::tab_style(
    style = list(
      gt::cell_text(weight = "bold")
      ),
    locations = gt::cells_body(
      columns = c("term","p.value"),
      rows = p.value < 0.05 )
  )
```
```{r}
bind_rows(list(shannon_random %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Random"),
  shannon_tolerant %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Tolerant"),
  shannon_mixed %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Mixed"),
  shannon_sensitive %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Sensitive"))) %>% 
  group_by(Syncom) %>% 
  gt::gt() %>% 
  #gt::tab_header("Table S3. ANOVA: Shannon Diversity") %>%  
  gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.05),
    fn = function(x) paste(x, "*")
  ) %>% 
    gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.01),
    fn = function(x) paste(x, "*")
  ) %>% gt::tab_style(
    style = list(
      gt::cell_text(align = "left")
      ),
    locations = gt::cells_body(columns = "p.value")
  ) %>% 
  gt::tab_style(
    style = list(
      gt::cell_text(weight = "bold")
      ),
    locations = gt::cells_body(
      columns = c("term","p.value"),
      rows = p.value < 0.05 )
  ) %>% 
  write_rds("TabS3_gt.rds")
```



```{r}
shannon_aov <- bind_rows(list(
  shannon_random %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Random"),
  shannon_tolerant %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Tolerant"),
  shannon_mixed %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Mixed"),
  shannon_sensitive %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  aov %>% 
  broom::tidy() %>% 
  mutate(Syncom = "Sensitive")))
```

```{r}
shannon_aov %>% write_rds("rds/shannon_aov.rds")
```

#### Tab S5

```{r}
shannon_aov %>% 
  group_by(Syncom) %>% 
  gt::gt() %>% 
  gt::tab_header("Table S5. ANOVA: Shannon Diversity") %>%  
  gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.05),
    fn = function(x) paste(x, "*")
  ) %>% 
    gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.01),
    fn = function(x) paste(x, "*")
  ) %>% gt::tab_style(
    style = list(
      gt::cell_text(align = "left")
      ),
    locations = gt::cells_body(columns = "p.value")
  ) %>% 
  gt::tab_style(
    style = list(
      gt::cell_text(weight = "bold")
      ),
    locations = gt::cells_body(
      columns = c("term","p.value"),
      rows = p.value < 0.05 )
  ) 
```
```{r}
shannon_aov %>% 
  group_by(Syncom) %>% 
  gt::gt() %>% 
  gt::tab_header("Table S5. ANOVA: Shannon Diversity") %>%  
  gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.05),
    fn = function(x) paste(x, "*")
  ) %>% 
    gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.01),
    fn = function(x) paste(x, "*")
  ) %>% gt::tab_style(
    style = list(
      gt::cell_text(align = "left")
      ),
    locations = gt::cells_body(columns = "p.value")
  ) %>% 
  gt::tab_style(
    style = list(
      gt::cell_text(weight = "bold")
      ),
    locations = gt::cells_body(
      columns = c("term","p.value"),
      rows = p.value < 0.05 )
  ) %>% 
  gt::gtsave("TabS5_shannon_aov.html")
```
```{r}
shannon_aov %>% 
  group_by(Syncom) %>% 
  gt::gt() %>% 
  gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.05),
    fn = function(x) paste(x, "*")
  ) %>% 
    gt::text_transform(
    locations = gt::cells_body(
      columns = "p.value",
      rows = p.value < 0.01),
    fn = function(x) paste(x, "*")
  ) %>% gt::tab_style(
    style = list(
      gt::cell_text(align = "left")
      ),
    locations = gt::cells_body(columns = "p.value")
  ) %>% 
  gt::tab_style(
    style = list(
      gt::cell_text(weight = "bold")
      ),
    locations = gt::cells_body(
      columns = c("term","p.value"),
      rows = p.value < 0.05 )
  ) %>% 
  write_rds("TabS3_gt.rds")
```

### Pairwise CLD

```{r}
shannon_all_cld <- bind_rows(list(
shannon_random %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  emmeans::emmeans( ~ Treatment, by = "Timepoint") %>% 
  emmeans::CLD(Letters = letters) %>%
  broom::tidy() %>% 
  {set_colnames(., c(colnames(.)[1:2],
                    "estimate",
                    "SE",
                    "Conf.lower",
                    "Conf.upper",
                    "Group"))} %>% 
  # Drop SE column since the model SE is not so interesting
    dplyr::select(-SE) %>% 
  mutate(Syncom = "Random"),
shannon_tolerant %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  emmeans::emmeans( ~ Treatment, by = "Timepoint") %>% 
  emmeans::CLD(Letters = letters) %>%
  broom::tidy() %>% 
  {set_colnames(., c(colnames(.)[1:2],
                    "estimate",
                    "SE",
                    "Conf.lower",
                    "Conf.upper",
                    "Group"))} %>% 
  # Drop SE column since the model SE is not so interesting
    dplyr::select(-SE) %>% 
  mutate(Syncom = "Tolerant"),
shannon_mixed %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  emmeans::emmeans( ~ Treatment, by = "Timepoint") %>% 
  emmeans::CLD(Letters = letters) %>%
  broom::tidy() %>% 
  {set_colnames(., c(colnames(.)[1:2],
                    "estimate",
                    "SE",
                    "Conf.lower",
                    "Conf.upper",
                    "Group"))} %>% 
  # Drop SE column since the model SE is not so interesting
    dplyr::select(-SE) %>% 
  mutate(Syncom = "Mixed"),
shannon_sensitive %>% 
  {lm(Shannon ~ Treatment*Timepoint, data = .)} %>% 
  emmeans::emmeans( ~ Treatment, by = "Timepoint") %>% 
  emmeans::CLD(Letters = letters) %>%
  broom::tidy() %>% 
  {set_colnames(., c(colnames(.)[1:2],
                    "estimate",
                    "SE",
                    "Conf.lower",
                    "Conf.upper",
                    "Group"))} %>% 
  # Drop SE column since the model SE is not so interesting
    dplyr::select(-SE) %>% 
  mutate(Syncom = "Sensitive"))) %>% 
  mutate(Group = str_extract(Group, "[a-z]+")) %>% 
  mutate("95% CI" = paste0("[", 
                           round(as.numeric(Conf.lower), 3),
                           " - ",
                           round(as.numeric(Conf.upper), 3),
                           "]")) %>% 
  dplyr::select(Syncom, Timepoint, Treatment, estimate, `95% CI`, Group)
```


```{r}
shannon_all_cld %>% write_rds("rds/shannon_all_cld.rds")
```

#### Tab S4

```{r}
shannon_all_cld %>% 
  mutate(estimate = round(estimate, 3)) %>% 
  group_by(Syncom, Timepoint) %>% 
  gt::gt()  %>% 
  gt::tab_header("Table S4. Shannon diversity means and pairwise comparisons") %>% 
  gt::tab_style(style = gt::cell_fill(color = "#cbe0ff"),
      locations = gt::cells_body(
      columns = c("Group"),
      rows = Group == "a" )) %>% 
  gt::tab_style(style = gt::cell_fill(color = "#ddc3d0"),
      locations = gt::cells_body(
      columns = c("Group"),
      rows = Group == "b")) %>%   
  gt::tab_footnote(
    footnote = "Different letters indicate significant differences within one Syncom / Timepoint combination (alpha = 0.05), Tukey adjusted",
    locations = gt::cells_column_labels(
      "Group"))
```
```{r}
shannon_all_cld %>% 
  mutate(estimate = round(estimate, 3)) %>% 
  group_by(Syncom, Timepoint) %>% 
  gt::gt()  %>% 
  gt::tab_header("Table S4. Shannon diversity means and pairwise comparisons") %>% 
  gt::tab_style(style = gt::cell_fill(color = "#cbe0ff"),
      locations = gt::cells_body(
      columns = c("Group"),
      rows = Group == "a" )) %>% 
  gt::tab_style(style = gt::cell_fill(color = "#ddc3d0"),
      locations = gt::cells_body(
      columns = c("Group"),
      rows = Group == "b")) %>%   
  gt::tab_footnote(
    footnote = "Different letters indicate significant differences within one Syncom / Timepoint combination (alpha = 0.05), Tukey adjusted",
    locations = gt::cells_column_labels(
      "Group")) %>% 
  gt::gtsave("TabS4_shannon_pairwise.html")
```
```{r}
shannon_all_cld %>% 
  mutate(estimate = round(estimate, 3)) %>% 
  group_by(Syncom, Timepoint) %>% 
  gt::gt()  %>% 
#  gt::tab_header("Table S4. Shannon diversity means and pairwise comparisons") %>% 
  gt::tab_style(style = gt::cell_fill(color = "#cbe0ff"),
      locations = gt::cells_body(
      columns = c("Group"),
      rows = Group == "a" )) %>% 
  gt::tab_style(style = gt::cell_fill(color = "#ddc3d0"),
      locations = gt::cells_body(
      columns = c("Group"),
      rows = Group == "b")) %>%   
  gt::tab_footnote(
    footnote = "Different letters indicate significant differences within one Syncom / Timepoint combination (alpha = 0.05), Tukey adjusted",
    locations = gt::cells_column_labels(
      "Group")) %>% 
  write_rds("TabS4_gt.rds")
```


# Relative abundance changes

## Calculate l2FC

### Random

```{r}
## APO /BOA
APO_BOA_random <- bind_rows(
phyl_random_glom_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>%   mutate(Timepoint = "24h"),
phyl_random_glom_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>% 
  mutate(Timepoint = "48h"),
phyl_random_glom_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>% 
  mutate(Timepoint = "72h"),
phyl_random_glom_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>% 
  mutate(Timepoint = "96h"))

## APO / Control

APO_DMSO_random <- bind_rows(
phyl_random_glom_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "24h"),
phyl_random_glom_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "48h"),
phyl_random_glom_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "72h"),
phyl_random_glom_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "96h"))

## BOA / Control

BOA_DMSO_random <- bind_rows(
phyl_random_glom_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "24h"),
phyl_random_glom_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "48h"),
phyl_random_glom_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "72h"),
phyl_random_glom_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "96h"))
```


### Tolerant

```{r}
## APO /BOA

APO_BOA_tolerant <- bind_rows(
phyl_tolerant_glom_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>% 
  mutate(Timepoint = "24h"),
phyl_tolerant_glom_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>% 
  mutate(Timepoint = "48h"),
phyl_tolerant_glom_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>% 
  mutate(Timepoint = "72h"),
phyl_tolerant_glom_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>% 
  mutate(Timepoint = "96h"))

## APO / Control

APO_DMSO_tolerant <- bind_rows(
phyl_tolerant_glom_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "24h"),
phyl_tolerant_glom_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "48h"),
phyl_tolerant_glom_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "72h"),
phyl_tolerant_glom_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "96h"))

## BOA / Control

BOA_DMSO_tolerant <- bind_rows(
phyl_tolerant_glom_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "24h"),
phyl_tolerant_glom_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "48h"),
phyl_tolerant_glom_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "72h"),
phyl_tolerant_glom_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "96h"))
```


### Mixed

```{r}
## APO /BOA

APO_BOA_mixed <- bind_rows(
phyl_mixed_glom_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>% 
  mutate(Timepoint = "24h"),
phyl_mixed_glom_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>% 
  mutate(Timepoint = "48h"),
phyl_mixed_glom_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>% 
  mutate(Timepoint = "72h"),
phyl_mixed_glom_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>% 
  mutate(Timepoint = "96h"))

## APO / Control

APO_DMSO_mixed <- bind_rows(
phyl_mixed_glom_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "24h"),
phyl_mixed_glom_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "48h"),
phyl_mixed_glom_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "72h"),
phyl_mixed_glom_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "96h"))

## BOA / Control

BOA_DMSO_mixed <- bind_rows(
phyl_mixed_glom_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "24h"),
phyl_mixed_glom_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "48h"),
phyl_mixed_glom_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "72h"),
phyl_mixed_glom_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "96h"))
```


### Sensitive

```{r}
## APO /BOA

APO_BOA_sensitive <- bind_rows(
phyl_sensitive_glom_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>% 
  mutate(Timepoint = "24h"),
phyl_sensitive_glom_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>% 
  mutate(Timepoint = "48h"),
phyl_sensitive_glom_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>% 
  mutate(Timepoint = "72h"),
phyl_sensitive_glom_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "BOA", plot = FALSE) %>% 
  mutate(Timepoint = "96h"))

## APO / Control

APO_DMSO_sensitive <- bind_rows(
phyl_sensitive_glom_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "24h"),
phyl_sensitive_glom_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "48h"),
phyl_sensitive_glom_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "72h"),
phyl_sensitive_glom_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "APO", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "96h"))

## BOA / Control

BOA_DMSO_sensitive <- bind_rows(
phyl_sensitive_glom_strain %>%
  subset_samples(Timepoint == "24h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "24h"),
phyl_sensitive_glom_strain %>%
  subset_samples(Timepoint == "48h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "48h"),
phyl_sensitive_glom_strain %>%
  subset_samples(Timepoint == "72h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "72h"),
phyl_sensitive_glom_strain %>%
  subset_samples(Timepoint == "96h") %>% 
  compare_conditions(treatvar = "Treatment", treat1= "BOA", treat2 = "Control", plot = FALSE) %>% 
  mutate(Timepoint = "96h"))
```


## Fig 3


```{r}
colors_l2fc <- wesanderson::wes_palette("Moonrise2", 3, "discrete")
```


```{r}
plot_sens_allcomparisons <- (bind_rows(
  list(APO_DMSO_sensitive %>% mutate(Comparison = "APO / Control"),
       APO_BOA_sensitive %>% mutate(Comparison = "APO / BOA"),
       BOA_DMSO_sensitive %>% mutate(Comparison = "BOA / Control"))) %>% 
  ggplot(aes( x = log2FoldChange, y = fct_rev(Genus), color = Comparison)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin = log2FoldChange - lfcSE, xmax = log2FoldChange + lfcSE), position = "dodge",width = 0.2) +
  geom_point() +
  geom_errorbar(aes(xmin = log2FoldChange - lfcSE, xmax = log2FoldChange + lfcSE), width = 0.2) +
  geom_vline(aes(xintercept = 0), lty = 3) +
  ylab(element_blank()) +
  facet_wrap(~Timepoint) +
 #ggtitle("Sensitive: log2FC") +
  scale_y_discrete(label=abbreviate) +
  theme_bw() +
  theme(text = element_text(family = "NimbusMon")) +
  scale_color_manual(values = colors_l2fc) +
  labs(x = "log2FoldChange (sensitive)") ) /
  (phyl_sensitive_rel_strain %>% 
  psmelt() %>%
  filter(Genus %in% c(APO_DMSO_sensitive$Genus,APO_BOA_sensitive$Genus, BOA_DMSO_sensitive$Genus)) %>%
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n")) %>% 
  ggplot(aes(y = Abundance, x = Timepoint, color = Treatment)) +
  stat_summary(aes(group = Treatment), fun.data = "mean_cl_boot", geom = "pointrange") +
  stat_summary(aes(group = Treatment), fun = "mean", geom = "line") +
  theme_bw() + 
  scale_y_continuous(n.breaks = 4) +
  #ggtitle(paste("Sensitive: Relative Genus abundances")) +
  ggthemes::scale_color_few() +
  facet_wrap(~Genus_Strain, scales = "free_y"))
```

```{r}
plot_mix_allcomparisons <- (bind_rows(
  list(APO_DMSO_mixed %>% mutate(Comparison = "APO / Control"),
       APO_BOA_mixed %>% mutate(Comparison = "APO / BOA"),
       BOA_DMSO_mixed %>% mutate(Comparison = "BOA / Control"))) %>% 
  ggplot(aes( x = log2FoldChange, y = fct_rev(Genus), color = Comparison)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin = log2FoldChange - lfcSE, xmax = log2FoldChange + lfcSE), position = "dodge",width = 0.2) +
  geom_point() +
  geom_errorbar(aes(xmin = log2FoldChange - lfcSE, xmax = log2FoldChange + lfcSE), width = 0.2) +
  geom_vline(aes(xintercept = 0), lty = 3) +
  ylab(element_blank()) +
  facet_wrap(~Timepoint) +
  #ggtitle("Mixed: log2FC") +
  scale_y_discrete(label=abbreviate) +
  theme_bw() +
  theme(text = element_text(family = "NimbusMon")) +
  scale_color_manual(values = colors_l2fc) +
  labs(x = "log2FoldChange (mixed)") ) /
  (phyl_mixed_rel_strain %>% 
  psmelt() %>%
  filter(Genus %in% c(APO_DMSO_mixed$Genus,APO_BOA_mixed$Genus, BOA_DMSO_mixed$Genus)) %>%
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n")) %>% 
  ggplot(aes(y = Abundance, x = Timepoint, color = Treatment)) +
  stat_summary(aes(group = Treatment), fun.data = "mean_cl_boot", geom = "pointrange") +
  stat_summary(aes(group = Treatment), fun = "mean", geom = "line") +
  theme_bw() +
  scale_y_continuous(n.breaks = 4) +
  #ggtitle(paste("Mixed: Relative Genus abundances")) +
  ggthemes::scale_color_few() +
  facet_wrap(~Genus_Strain, scales = "free_y"))
```

```{r}
plot_tol_allcomparisons <- (bind_rows(
  list(APO_DMSO_tolerant %>% mutate(Comparison = "APO / Control"),
       APO_BOA_tolerant %>% mutate(Comparison = "APO / BOA"),
       BOA_DMSO_tolerant %>% mutate(Comparison = "BOA / Control"))) %>% 
  filter(Genus != "Nocardioides") %>%
  ggplot(aes( x = log2FoldChange, y = fct_rev(Genus), color = Comparison)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin = log2FoldChange - lfcSE, xmax = log2FoldChange + lfcSE), position = "dodge",width = 0.2) +
  geom_point() +
  geom_errorbar(aes(xmin = log2FoldChange - lfcSE, xmax = log2FoldChange + lfcSE), width = 0.2) +
  geom_vline(aes(xintercept = 0), lty = 3) +
  ylab(element_blank()) +
  facet_wrap(~Timepoint) +
  #ggtitle("Tolerant: log2FC") +
  scale_y_discrete(label=abbreviate) +   
  theme_bw() +
  theme(text = element_text(family = "NimbusMon")) +
  scale_color_manual(values = colors_l2fc) +
  labs(x = "log2FoldChange (tolerant)") ) /
  (phyl_tolerant_rel_strain %>% 
  psmelt() %>%
  filter(Genus %in% c(APO_DMSO_tolerant$Genus, APO_BOA_tolerant$Genus, BOA_DMSO_tolerant$Genus),
         Genus != "Nocardioides") %>%
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n")) %>% 
  ggplot(aes(y = Abundance, x = Timepoint, color = Treatment)) +
  stat_summary(aes(group = Treatment), fun.data = "mean_cl_boot", geom = "pointrange") +
  stat_summary(aes(group = Treatment), fun = "mean", geom = "line") +
  theme_bw() + 
  scale_y_continuous(n.breaks = 4) +
  #ggtitle(paste("Tolerant: Relative Genus abundances")) +
  ggthemes::scale_color_few() +
  facet_wrap(~Genus_Strain, scales = "free_y",nrow = 2))
```


```{r}
plot_rand_allcomparisons <- (bind_rows(
  list(APO_DMSO_random %>% mutate(Comparison = "APO / Control"),
       APO_BOA_random %>% mutate(Comparison = "APO / BOA"),
       BOA_DMSO_random %>% mutate(Comparison = "BOA / Control"))) %>% 
  ggplot(aes( x = log2FoldChange, y = fct_rev(Genus), color = Comparison)) +
  geom_point(position = position_dodge(0.5)) +
  geom_errorbar(aes(xmin = log2FoldChange - lfcSE, xmax = log2FoldChange + lfcSE), position = "dodge",width = 0.2) +
  geom_point() +
  geom_errorbar(aes(xmin = log2FoldChange - lfcSE, xmax = log2FoldChange + lfcSE), width = 0.2) +
  geom_vline(aes(xintercept = 0), lty = 3) +
  ylab(element_blank()) +
  facet_wrap(~Timepoint) +
  #ggtitle("Random: log2FC") +
  scale_y_discrete(label=abbreviate) +
  theme_bw() +
  theme(text = element_text(family = "NimbusMon")) +
  scale_color_manual(values = colors_l2fc) +
  labs(x = "log2FoldChange (random)") ) /
  (phyl_random_rel_strain %>% 
  psmelt() %>%
  filter(Genus %in% c(APO_DMSO_random$Genus, APO_BOA_random$Genus, BOA_DMSO_random$Genus)) %>%
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n")) %>% 
  ggplot(aes(y = Abundance, x = Timepoint, color = Treatment)) +
  stat_summary(aes(group = Treatment), fun.data = "mean_cl_boot", geom = "pointrange") +
  stat_summary(aes(group = Treatment), fun = "mean", geom = "line") +
  theme_bw() + 
  scale_y_continuous(n.breaks = 4) +
  #ggtitle(paste("Random: Relative Genus abundances")) +
  ggthemes::scale_color_few() +
  facet_wrap(~Genus_Strain, scales = "free_y",nrow = 2))
```

### Fig 3 - Plot

```{r}
((plot_rand_allcomparisons | plot_tol_allcomparisons) / (plot_mix_allcomparisons | plot_sens_allcomparisons)) +
  plot_annotation(tag_levels = "A") +
  plot_layout(guides = 'collect' ) &
  theme(text = element_text(family ="NimbusMon"),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(size = 8),
        legend.position = "bottom") 
```

### Fig 3 extended

This shows all isolates in each syncom, not only those that change significantly. Bordetella Root565 sticks out, since it performs very similarily in random and tolerant, is slightly (not significantly) more abundant in APO. 

```{r}
relabund_random <- phyl_random_rel_strain %>% 
  psmelt() %>%
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n")) %>% 
  ggplot(aes(y = Abundance, x = Timepoint, color = Treatment)) +
  stat_summary(aes(group = Treatment), fun.data = "mean_cl_boot", geom = "pointrange") +
  stat_summary(aes(group = Treatment), fun = "mean", geom = "line") +
  theme_bw() + 
  scale_y_continuous(n.breaks = 4) +
  #ggtitle(paste("Random: Relative Genus abundances")) +
  ggthemes::scale_color_few() +
  facet_wrap(~Genus_Strain, scales = "free_y")
relabund_tolerant <- phyl_tolerant_rel_strain %>% 
  psmelt() %>%
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n")) %>% 
  ggplot(aes(y = Abundance, x = Timepoint, color = Treatment)) +
  stat_summary(aes(group = Treatment), fun.data = "mean_cl_boot", geom = "pointrange") +
  stat_summary(aes(group = Treatment), fun = "mean", geom = "line") +
  theme_bw() + 
  scale_y_continuous(n.breaks = 4) +
  #ggtitle(paste("Random: Relative Genus abundances")) +
  ggthemes::scale_color_few() +
  facet_wrap(~Genus_Strain, scales = "free_y")
relabund_mixed <- phyl_mixed_rel_strain %>% 
  psmelt() %>%
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n")) %>% 
  ggplot(aes(y = Abundance, x = Timepoint, color = Treatment)) +
  stat_summary(aes(group = Treatment), fun.data = "mean_cl_boot", geom = "pointrange") +
  stat_summary(aes(group = Treatment), fun = "mean", geom = "line") +
  theme_bw() + 
  scale_y_continuous(n.breaks = 4) +
  #ggtitle(paste("Random: Relative Genus abundances")) +
  ggthemes::scale_color_few() +
  facet_wrap(~Genus_Strain, scales = "free_y")
relabund_sensitive <- phyl_sensitive_rel_strain %>% 
  psmelt() %>%
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n")) %>% 
  ggplot(aes(y = Abundance, x = Timepoint, color = Treatment)) +
  stat_summary(aes(group = Treatment), fun.data = "mean_cl_boot", geom = "pointrange") +
  stat_summary(aes(group = Treatment), fun = "mean", geom = "line") +
  theme_bw() + 
  scale_y_continuous(n.breaks = 4) +
  #ggtitle(paste("Random: Relative Genus abundances")) +
  ggthemes::scale_color_few() +
  facet_wrap(~Genus_Strain, scales = "free_y")
```

```{r}
(relabund_random | relabund_tolerant) /
  (relabund_mixed | relabund_sensitive) +
  plot_annotation(tag_levels = "A") +
  plot_layout(guides = 'collect' ) &
  theme(text = element_text(family ="NimbusMon"),
        strip.background = element_rect(fill = "white"),
        legend.position = "bottom") 
```

### Correlation community l2fc with growth assays

```{r}
fold_changes_communities <- bind_rows(list(
       APO_DMSO_sensitive %>% mutate(Comparison = "APO / Control", Syncom = "Sensitive"),
       BOA_DMSO_sensitive %>% mutate(Comparison = "BOA / Control", Syncom = "Sensitive"),
       APO_DMSO_tolerant %>% mutate(Comparison = "APO / Control", Syncom = "Tolerant"),
       BOA_DMSO_tolerant %>% mutate(Comparison = "BOA / Control", Syncom = "Tolerant"),
       APO_DMSO_mixed %>% mutate(Comparison = "APO / Control", Syncom = "Mixed"),
       BOA_DMSO_mixed %>% mutate(Comparison = "BOA / Control", Syncom = "Mixed"),
       APO_DMSO_random %>% mutate(Comparison = "APO / Control", Syncom = "Random"),
       BOA_DMSO_random %>% mutate(Comparison = "BOA / Control", Syncom = "Random")))

fold_changes_communities

all_strains <- bind_rows(list(phyl_tolerant_rel_strain %>% 
  psmelt() %>%
  dplyr::select(Genus, Strain, Syncom),
phyl_random_rel_strain %>% 
  psmelt() %>% 
  dplyr::select(Genus, Strain, Syncom),
  phyl_sensitive_rel_strain %>% 
  psmelt() %>% 
  dplyr::select(Genus, Strain, Syncom),
  phyl_mixed_rel_strain %>% 
  psmelt() %>%
  dplyr::select(Genus, Strain, Syncom))) %>% 
  separate(Syncom, into = c(NA, "Syncom"), sep ="_") 

strain_AUC_rel <- AUC_emmeans %>%
  filter(Treat.x %in% c("Control","50uM_APO","100uM_BOA")) %>%
  mutate(Treatment = case_when(Treat.x == "Control" ~ Treat.x,
                               Treat.x == "50uM_APO" ~ "APO",
                               Treat.x == "100uM_BOA" ~ "BOA")) %>% 
  dplyr::select(Strain, Treatment, estimate) %>%
  group_by(Strain,Treatment) %>%
  summarize(mean_rel_AUC = mean(estimate, na.rm = T)) %>%
  ungroup  %>% 
  unique
```

```{r}
fold_changes_communities %>%
  separate(Comparison, c("Treatment", NA), sep = " / ") %>% 
  left_join(all_strains, by = c("Genus","Syncom")) %>% 
  left_join(strain_AUC_rel, by = c("Strain", "Treatment")) %>% 
  unique() %>% 
  filter(Treatment == "APO") %>% 
  droplevels() %>%
  {cor(x = .$log2FoldChange, y=.$mean_rel_AUC)}
```

```{r}
fold_changes_communities %>%
  separate(Comparison, c("Treatment", NA), sep = " / ") %>% 
  left_join(all_strains, by = c("Genus","Syncom")) %>% 
  left_join(strain_AUC_rel, by = c("Strain", "Treatment")) %>% 
  unique() %>% 
  filter(Treatment == "APO") %>% 
  droplevels() %>% 
  ggplot(aes(x = log2FoldChange, y = mean_rel_AUC)) +
  geom_point() +
  facet_grid(Syncom ~ Timepoint)
```


## Overlap Random and Tolerant

```{r}
tol_strains <- phyl_tolerant_rel_strain %>% 
  psmelt() %>% .$Strain
rand_strains <- phyl_random_rel_strain %>% 
  psmelt() %>% .$Strain
rand_tol_genusstrain <- rbind(phyl_tolerant_rel_strain %>% 
  psmelt() %>%
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n")) %>% 
  dplyr::select(Strain, Genus_Strain),
  phyl_random_rel_strain %>% 
  psmelt() %>%
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n")) %>% 
  dplyr::select(Strain, Genus_Strain)) %>% 
  distinct()
```

```{r}
relabund_random_overlap_tol <- phyl_random_rel_strain %>% 
  psmelt() %>%
  filter(Strain %in% (phyl_tolerant_rel_strain %>% 
  psmelt() %>% .$Strain)) %>% 
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n")) %>% 
  ggplot(aes(y = Abundance, x = Timepoint, color = Treatment)) +
  stat_summary(aes(group = Treatment), fun.data = "mean_cl_boot", geom = "pointrange") +
  stat_summary(aes(group = Treatment), fun = "mean", geom = "line") +
  theme_bw() + 
  scale_y_continuous(n.breaks = 4) +
  ggtitle(paste("Random: Strains overlapping with Tolerant")) +
  ggthemes::scale_color_few() +
  facet_wrap(~Genus_Strain, scales = "free_y")
relabund_tolerant_overlap_rand <- phyl_tolerant_rel_strain %>% 
  psmelt() %>%
  filter(Strain %in% (phyl_random_rel_strain %>% 
  psmelt() %>% .$Strain)) %>% 
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n")) %>% 
  ggplot(aes(y = Abundance, x = Timepoint, color = Treatment)) +
  stat_summary(aes(group = Treatment), fun.data = "mean_cl_boot", geom = "pointrange") +
  stat_summary(aes(group = Treatment), fun = "mean", geom = "line") +
  theme_bw() + 
  scale_y_continuous(n.breaks = 4) +
  ggtitle(paste("Tolerant: Strains overlapping with Random")) +
  ggthemes::scale_color_few() +
  facet_wrap(~Genus_Strain, scales = "free_y")
```

```{r}
rand_tol_relabund_overlap_plot <-
  phyl_random_rel_strain %>% 
  psmelt() %>%
  filter(Strain %in% (phyl_tolerant_rel_strain %>% 
  psmelt() %>% .$Strain)) %>% 
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n"),
         Syncom = "Random") %>% 
  rbind(phyl_tolerant_rel_strain %>% 
  psmelt() %>%
  filter(Strain %in% (phyl_random_rel_strain %>% 
  psmelt() %>% .$Strain)) %>% 
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n"),
         Syncom = "Tolerant") ) %>% 
  ggplot(aes(y = Abundance, x = Timepoint, color = Treatment)) +
  stat_summary(aes(group = Treatment), fun.data = "mean_cl_boot", geom = "pointrange") +
  stat_summary(aes(group = Treatment), fun = "mean", geom = "line") +
  theme_bw() + 
  scale_y_continuous(n.breaks = 4) +
  ggtitle(paste("Relative abundance of overlapping isolates")) +
  ggthemes::scale_color_few() +
  facet_wrap(~paste(Syncom, Genus_Strain, sep = "\n"),
             scales = "free_y",
             ncol = 5,
             strip.position = "top") +
  theme(legend.position = "bottom",
        text = element_text(family = "NimbusMon"), 
        strip.background = element_rect(fill = "white"),
        strip.text.y = element_blank())
```

```{r}
relabund_random_overlap_tol /
  relabund_tolerant_overlap_rand +
  plot_layout(guides = "collect") &
    theme(text = element_text(family ="NimbusMon"),
        strip.background = element_rect(fill = "white"),
        legend.position = "bottom")
```

# Fig 4

## Plot of overlapping strains

```{r}
rand_tol_relabund_overlap_plot <-
  phyl_random_rel_strain %>% 
  psmelt() %>%
  filter(Strain %in% (phyl_tolerant_rel_strain %>% 
  psmelt() %>% .$Strain)) %>% 
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n"),
         Syncom = "Random") %>% 
  rbind(phyl_tolerant_rel_strain %>% 
  psmelt() %>%
  filter(Strain %in% (phyl_random_rel_strain %>% 
  psmelt() %>% .$Strain)) %>% 
  mutate(Genus_Strain = paste(Genus, Strain, sep = "\n"),
         Syncom = "Tolerant") ) %>% 
  ggplot(aes(y = Abundance, x = Timepoint, color = Treatment)) +
  stat_summary(aes(group = Treatment), fun.data = "mean_cl_boot", geom = "pointrange") +
  stat_summary(aes(group = Treatment), fun = "mean", geom = "line") +
  theme_bw() + 
  scale_y_continuous(n.breaks = 4) +
  ggtitle(paste("Relative abundance of overlapping isolates")) +
  ggthemes::scale_color_few() +
  facet_wrap(~paste(Syncom, Genus_Strain, sep = "\n"),
             scales = "free_y",
             ncol = 5,
             strip.position = "top") +
  theme(legend.position = "bottom",
        text = element_text(family = "NimbusMon"), 
        strip.background = element_rect(fill = "white"),
        strip.text.y = element_blank())
```

```{r}
abundances_tol_rand <- bind_rows(list(phyl_tolerant_rel_strain %>% 
  psmelt() %>%
  dplyr::select(Strain, Treatment, Timepoint, Abundance) %>% 
  mutate(Syncom = "Tolerant"),
  phyl_random_rel_strain %>% 
  psmelt() %>%
  dplyr::select(Strain, Treatment, Timepoint, Abundance) %>% 
  mutate(Syncom = "Random")))
```

```{r}
tolerant_strains_genus <- phyl_tolerant_rel_strain %>% 
  psmelt() %>%
  dplyr::select(Genus, Strain) %>%
  mutate(Syncom = "Tolerant") %>% 
  distinct()
random_strains_genus <- phyl_random_rel_strain %>% 
  psmelt() %>% 
  dplyr::select(Genus, Strain) %>%
  mutate(Syncom = "Random") %>% 
  distinct()
```

## Correlations

```{r}
tol_apo_boa_24_96 <- bind_rows(
  list(
  phyl_tolerant_glom_strain %>% 
  subset_samples(Timepoint == "96h") %>%
  create_corrnet("Treatment",
                 "APO",
                 99, 
                 method = "pearson",
                 OTUcol = "Genus") %>%
    mutate(Treatment = "APO",
           Syncom = "Tolerant",
           Timepoint = "96h"),
  phyl_tolerant_glom_strain %>% 
  subset_samples(Timepoint == "24h") %>%
  create_corrnet("Treatment",
                 "APO",
                 99, 
                 method = "pearson",
                 OTUcol = "Genus") %>%
    mutate(Treatment = "APO",
           Syncom = "Tolerant",
           Timepoint = "24h"),
phyl_tolerant_glom_strain %>% 
  subset_samples(Timepoint == "96h") %>%
  create_corrnet("Treatment",
                 "BOA",
                 99, 
                 method = "pearson",
                 OTUcol = "Genus") %>% 
  mutate(Treatment = "BOA",
         Timepoint = "96h",
          Syncom = "Tolerant"),
phyl_tolerant_glom_strain %>% 
  subset_samples(Timepoint == "24h") %>%
  create_corrnet("Treatment",
                 "BOA",
                 99, 
                 method = "pearson",
                 OTUcol = "Genus") %>% 
  mutate(Treatment = "BOA",
         Timepoint = "24h",
          Syncom = "Tolerant")))

rand_apo_boa_24_96 <- bind_rows(list(phyl_random_glom_strain %>% 
  subset_samples(Timepoint == "96h") %>%
  create_corrnet("Treatment",
                 "APO",
                 99,
                 method = "pearson",
                 OTUcol = "Genus") %>%
    mutate(Treatment = "APO",
           Timepoint = "96h",
           Syncom = "Random") ,
  phyl_random_glom_strain %>% 
  subset_samples(Timepoint == "24h") %>%
  create_corrnet("Treatment",
                 "APO",
                 99,
                 method = "pearson",
                 OTUcol = "Genus") %>%
    mutate(Treatment = "APO",
           Timepoint = "24h",
           Syncom = "Random") ,
phyl_random_glom_strain %>% 
  subset_samples(Timepoint == "96h") %>%
  create_corrnet("Treatment",
                 "BOA",
                 99, 
                 method = "pearson",
                 OTUcol = "Genus") %>% 
  mutate(Treatment = "BOA",
         Timepoint = "96h",
           Syncom = "Random"),
phyl_random_glom_strain %>% 
  subset_samples(Timepoint == "24h") %>%
  create_corrnet("Treatment",
                 "BOA",
                 99, 
                 method = "pearson",
                 OTUcol = "Genus") %>% 
  mutate(Treatment = "BOA",
         Timepoint = "24h",
           Syncom = "Random")
)) 

tol_rand_apo_boa_24_96_corrs_p <- rbind(tol_apo_boa_24_96, rand_apo_boa_24_96) %>% 
  filter(abs(r) > 0.5)
```

```{r}
# Set seed for reproducibility of layout
set.seed(21356)
corrnetwork_plot <- tol_rand_apo_boa_24_96_corrs_p  %>% 
  graph_from_data_frame() %>% 
  { permute(., sample(vcount(.))) } %>% 
  ggnetwork::ggnetwork(layout = igraph::in_circle(),
                        arrow.gap = F) %>% 
  distinct() %>% 
  fix_node_placement() %>% 
  mutate(Genus = name) %>%  
  left_join(rbind(tolerant_strains_genus, random_strains_genus),
            by = c("Syncom","Genus")) %>% 
  mutate(presence = case_when(Strain %in% intersect(tol_strains, rand_strains) ~ "Both",
                               Strain %in% tol_strains ~ "Only one",
                               Strain %in% rand_strains ~ "Only one",
                               TRUE ~"Neither")) %>% 
  left_join(abundances_tol_rand, by = c("Syncom","Strain","Treatment","Timepoint")) %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_edges(aes(color = r), curvature = 0.2) +
  geom_nodes(aes(size = Abundance)) +
  geom_nodelabel_repel(aes(label = paste(Genus, Strain, sep = "\n"), family = "NimbusMon"),  seed =1232, size= 2) +
  geom_nodelabel_repel(aes(label = paste(Genus, Strain, sep = "\n"),  fill = presence, family = "NimbusMon"), alpha = 0.3, seed=1232, size= 2) +
  ggtitle("Correlation network") +
  scale_color_viridis_c(option = "C") +
  ggthemes::scale_fill_canva(palette = 'Corporate and sleek') +
  facet_grid(Syncom~paste(Treatment, Timepoint, sep = ": "), scales = "free") +
  theme_blank() +
  theme(text = element_text(family = "NimbusMon"),
        strip.background = element_rect(fill = "white"),
        panel.border = element_rect(fill = NA)) +
  lims(x = c(-0.2,1.2),
      y = c(-0.2,1.2)) +
  NULL
```

## Figure

```{r}
rand_tol_relabund_overlap_plot /
  corrnetwork_plot +
  theme(legend.position = "bottom") +
  plot_layout(heights = c(1,3)) +
  plot_annotation(tag_levels = "A") &
  theme(text = element_text(family = "NimbusMon"),
        strip.background = element_rect(fill = "white"))
```

## Some network descriptive stats

```{r}
edge_count <- tol_rand_apo_boa_24_96_corrs_p  %>% 
  graph_from_data_frame() %>% 
  { permute(., sample(vcount(.))) }%>% 
  ggnetwork::ggnetwork(layout = igraph::in_circle(),
                       arrow.gap = F) %>% 
  distinct() %>%
  fix_node_placement() %>% filter(!is.na(r)) %>%
  {split(.,interaction(.$Timepoint, .$Syncom, .$Treatment))} %>% 
  map_dfr(~nrow(.x)) %>% t() %>% as_tibble(rownames = "Condition") %>% 
  set_colnames(c("Condition", "edges"))
```
```{r}
node_count <- tol_rand_apo_boa_24_96_corrs_p  %>% 
  graph_from_data_frame() %>% 
  { permute(., sample(vcount(.))) }%>% 
  ggnetwork::ggnetwork(layout = igraph::in_circle(),
                       arrow.gap = F) %>% 
  distinct() %>%
  fix_node_placement() %>%
  filter(is.na(r)) %>%
  {split(.,interaction(.$Timepoint, .$Syncom, .$Treatment))} %>% 
  map_dfr(~nrow(.x)) %>% t() %>% as_tibble(rownames = "Condition") %>% 
  set_colnames(c("Condition", "nodes"))
```

```{r}
left_join(node_count, edge_count) %>% 
  mutate(Edges_per_node = edges/nodes)
```

```{r}
tol_rand_apo_boa_24_96_corrs_p  %>%
  {split(.,interaction(.$Timepoint, .$Syncom, .$Treatment))} %>% 
  map_dfr(~ graph_from_data_frame(.x) %>% betweenness(), .id = "Condition")  %>% 
  pivot_longer(2:14, names_to = "Genus", values_to = "Betweenness") %>% 
  group_by(Condition) %>% 
  mutate(rel_betw = Betweenness / sum(Betweenness, na.rm = T)) %>% 
  ungroup() %>% 
  separate("Condition", c("Timepoint", "Syncom","Treatment"), sep ="\\.") %>% 
  ggplot(aes(x=Syncom, y = Betweenness, fill = Timepoint)) +
  geom_col(position = "dodge2") +
  facet_wrap(Genus~Treatment)
```
```{r}
tol_rand_apo_boa_24_96_corrs_p  %>%
  {split(.,interaction(.$Timepoint, .$Syncom, .$Treatment))} %>% 
  map_dfr(~ graph_from_data_frame(.x) %>% degree(), .id = "Condition") %>% 
  pivot_longer(2:14, names_to = "Genus", values_to = "Degree") %>% 
  group_by(Condition) %>% 
  mutate(rel_degree = Degree / sum(Degree, na.rm = T)) %>% 
  ungroup() %>% 
  separate("Condition", c("Timepoint", "Syncom","Treatment"), sep ="\\.") %>% 
  ggplot(aes(x=Syncom, y = Degree, fill = Timepoint)) +
  geom_col(position = "dodge2") +
  facet_wrap(Genus~Treatment)
```


#### Add DMSO to this

```{r}
tol_rand_all_24_96_corrs_p <- tol_rand_apo_boa_24_96_corrs_p %>% 
  bind_rows(list(phyl_random_glom_strain %>% 
  subset_samples(Timepoint == "96h") %>%
  create_corrnet("Treatment",
                 "DMSO",
                 99,
                 method = "pearson",
                 OTUcol = "Genus") %>%
    mutate(Treatment = "Control",
           Timepoint = "96h",
           Syncom = "Random") ,
  phyl_random_glom_strain %>% 
  subset_samples(Timepoint == "24h") %>%
  create_corrnet("Treatment",
                 "DMSO",
                 99,
                 method = "pearson",
                 OTUcol = "Genus")%>%
    mutate(Treatment = "Control",
           Timepoint = "24h",
           Syncom = "Random"),
  phyl_tolerant_glom_strain %>% 
  subset_samples(Timepoint == "96h") %>%
  create_corrnet("Treatment",
                 "DMSO",
                 99,
                 method = "pearson",
                 OTUcol = "Genus") %>%
    mutate(Treatment = "Control",
           Timepoint = "96h",
           Syncom = "Tolerant") ,
  phyl_tolerant_glom_strain %>% 
  subset_samples(Timepoint == "24h") %>%
  create_corrnet("Treatment",
                 "DMSO",
                 99,
                 method = "pearson",
                 OTUcol = "Genus") %>%
    mutate(Treatment = "Control",
           Timepoint = "24h",
           Syncom = "Tolerant")))
```

```{r}
tol_rand_all_24_96_corrs_p %>% 
  filter(abs(r) > 0.5) %>% 
  graph_from_data_frame() %>% 
  ggnetwork::ggnetwork(layout = igraph::with_fr(),
                       arrow.gap = F) %>% 
  distinct() %>% 
  fix_node_placement(Treatments = list("Control","BOA","APO")) %>% 
  mutate(Genus = name) %>%  
  left_join(rbind(tolerant_strains_genus, random_strains_genus),
            by = c("Syncom","Genus")) %>% 
  mutate(presence = case_when(Strain %in% intersect(tol_strains, rand_strains) ~ "Both",
                               Strain %in% tol_strains ~ "Only one",
                               Strain %in% rand_strains ~ "Only one",
                               TRUE ~"Neither")) %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_edges(aes(color = r), curvature = 0.2) +
  geom_nodes() +
  geom_nodelabel_repel(aes(label = paste(Genus, Strain, sep = "\n")),  seed = 342, size= 2) +
  geom_nodelabel_repel(aes(label = paste(Genus, Strain, sep = "\n"),  fill = presence), alpha = 0.3, seed=342, size= 2) +
  ggtitle("Tolerant and Random",
          sub = "pearson > 0.5") +
  scale_color_viridis_c(option = "C") +
  ggthemes::scale_fill_canva(palette = 'Corporate and sleek') +
  facet_grid(Syncom~interaction(Treatment, Timepoint), scales = "free") +
  theme_blank() +
  theme(text = element_text(family = "NimbusMon"),
        strip.background = element_rect(fill = "white"),
        panel.border = element_rect(fill = NA)) +
  # lims(x = c(-0.1,1.1),
  #      y = c(-0.1,1.1)) +
  NULL
```

```{r}
edge_count <- tol_rand_all_24_96_corrs_p  %>% 
  graph_from_data_frame() %>% 
  { permute(., sample(vcount(.))) }%>% 
  ggnetwork::ggnetwork(layout = igraph::in_circle(),
                       arrow.gap = F) %>% 
  distinct() %>%
  fix_node_placement() %>%
  filter(!is.na(r)) %>%
  {split(.,interaction(.$Timepoint, .$Syncom, .$Treatment))} %>% 
  map_dfr(~nrow(.x)) %>% t() %>% as_tibble(rownames = "Condition") %>% 
  set_colnames(c("Condition", "edges"))
```
```{r}
node_count <- tol_rand_all_24_96_corrs_p  %>% 
  graph_from_data_frame() %>% 
  { permute(., sample(vcount(.))) }%>% 
  ggnetwork::ggnetwork(layout = igraph::in_circle(),
                       arrow.gap = F) %>% 
  distinct() %>%
  fix_node_placement(Treatments = list("APO","BOA","Control")) %>%
  filter(is.na(r)) %>%
  {split(.,interaction(.$Timepoint, .$Syncom, .$Treatment))} %>% 
  map_dfr(~nrow(.x)) %>% t() %>% as_tibble(rownames = "Condition") %>% 
  set_colnames(c("Condition", "nodes"))
```

```{r}
left_join(node_count, edge_count) %>% 
  mutate(Edges_per_node = edges/nodes) %>% 
  separate("Condition", c("Timepoint","Syncom","Treatment"), sep = "\\.") %>% 
  arrange(Timepoint,Syncom,desc(Treatment)) %>% 
  group_by(Timepoint, Syncom) %>% 
  gt::gt()
```

# Fig S4

## Add Timepoints, treatments

```{r}
tol_rand_all_corrs_p <- tol_rand_all_24_96_corrs_p %>% 
  bind_rows(list(
    phyl_random_glom_strain %>% 
  subset_samples(Timepoint == "48h") %>%
  create_corrnet("Treatment",
                 "DMSO",
                 99,
                 method = "pearson",
                 OTUcol = "Genus") %>%
    mutate(Treatment = "Control",
           Timepoint = "48h",
           Syncom = "Random") ,
  phyl_random_glom_strain %>% 
  subset_samples(Timepoint == "72h") %>%
  create_corrnet("Treatment",
                 "DMSO",
                 99,
                 method = "pearson",
                 OTUcol = "Genus")%>%
    mutate(Treatment = "Control",
           Timepoint = "72h",
           Syncom = "Random"),
    phyl_random_glom_strain %>% 
  subset_samples(Timepoint == "48h") %>%
  create_corrnet("Treatment",
                 "BOA",
                 99,
                 method = "pearson",
                 OTUcol = "Genus") %>%
    mutate(Treatment = "BOA",
           Timepoint = "48h",
           Syncom = "Random") ,
  phyl_random_glom_strain %>% 
  subset_samples(Timepoint == "72h") %>%
  create_corrnet("Treatment",
                 "BOA",
                 99,
                 method = "pearson",
                 OTUcol = "Genus")%>%
    mutate(Treatment = "BOA",
           Timepoint = "72h",
           Syncom = "Random"),
    phyl_random_glom_strain %>% 
  subset_samples(Timepoint == "48h") %>%
  create_corrnet("Treatment",
                 "APO",
                 99,
                 method = "pearson",
                 OTUcol = "Genus") %>%
    mutate(Treatment = "APO",
           Timepoint = "48h",
           Syncom = "Random") ,
  phyl_random_glom_strain %>% 
  subset_samples(Timepoint == "72h") %>%
  create_corrnet("Treatment",
                 "APO",
                 99,
                 method = "pearson",
                 OTUcol = "Genus")%>%
    mutate(Treatment = "APO",
           Timepoint = "72h",
           Syncom = "Random"),
 ####
 phyl_tolerant_glom_strain %>% 
  subset_samples(Timepoint == "48h") %>%
  create_corrnet("Treatment",
                 "DMSO",
                 99,
                 method = "pearson",
                 OTUcol = "Genus") %>%
    mutate(Treatment = "Control",
           Timepoint = "48h",
           Syncom = "Tolerant") ,
  phyl_tolerant_glom_strain %>% 
  subset_samples(Timepoint == "72h") %>%
  create_corrnet("Treatment",
                 "DMSO",
                 99,
                 method = "pearson",
                 OTUcol = "Genus")%>%
    mutate(Treatment = "Control",
           Timepoint = "72h",
           Syncom = "Tolerant"),
    phyl_tolerant_glom_strain %>% 
  subset_samples(Timepoint == "48h") %>%
  create_corrnet("Treatment",
                 "BOA",
                 99,
                 method = "pearson",
                 OTUcol = "Genus") %>%
    mutate(Treatment = "BOA",
           Timepoint = "48h",
           Syncom = "Tolerant") ,
  phyl_tolerant_glom_strain %>% 
  subset_samples(Timepoint == "72h") %>%
  create_corrnet("Treatment",
                 "BOA",
                 99,
                 method = "pearson",
                 OTUcol = "Genus")%>%
    mutate(Treatment = "BOA",
           Timepoint = "72h",
           Syncom = "Tolerant"),
    phyl_tolerant_glom_strain %>% 
  subset_samples(Timepoint == "48h") %>%
  create_corrnet("Treatment",
                 "APO",
                 99,
                 method = "pearson",
                 OTUcol = "Genus") %>%
    mutate(Treatment = "APO",
           Timepoint = "48h",
           Syncom = "Tolerant") ,
  phyl_tolerant_glom_strain %>% 
  subset_samples(Timepoint == "72h") %>%
  create_corrnet("Treatment",
                 "APO",
                 99,
                 method = "pearson",
                 OTUcol = "Genus") %>%
    mutate(Treatment = "APO",
           Timepoint = "72h",
           Syncom = "Tolerant") ))
```

## Figure S4

```{r}
set.seed(646549)
plot_dat <- tol_rand_all_corrs_p %>% 
  graph_from_data_frame() %>% 
  { permute(., sample(vcount(.))) }%>% 
  ggnetwork::ggnetwork(layout = igraph::in_circle(),
                       arrow.gap = F) %>% 
  distinct() %>%
  fix_node_placement(Treatments = list("APO","BOA","Control"),
                     Timepoints = list("24h", "48h", "72h", "96h")) %>% 
  mutate(Genus = name) %>%  
  left_join(rbind(tolerant_strains_genus, random_strains_genus),
            by = c("Syncom","Genus")) %>% 
  mutate(presence = case_when(Strain %in% intersect(tol_strains, rand_strains) ~ "Both",
                               Strain %in% tol_strains ~ "Only one",
                               Strain %in% rand_strains ~ "Only one",
                               TRUE ~"Neither"))
FigS4A <- plot_dat %>%
  filter(Syncom == "Random") %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_edges(aes(color = r), curvature = 0.05) +
  geom_nodes() +
  geom_nodelabel_repel(aes(label = paste(Genus, Strain, sep = "\n"), family = "NimbusMon"),  seed =1232, size= 2) +
  geom_nodelabel_repel(aes(label = paste(Genus, Strain, sep = "\n"),  fill = presence, family = "NimbusMon"), alpha = 0.3, seed=1232, size= 2) +
  ggtitle("Random syncom") +
  scale_color_viridis_c(option = "C") +
  ggthemes::scale_fill_canva(palette = 'Corporate and sleek') +
  facet_grid(Timepoint~Treatment, scales = "free") +
  theme_blank() +
  theme(text = element_text(family = "NimbusMon"),
        strip.background = element_rect(fill = "white"),
        panel.border = element_rect(fill = NA)) +
  # lims(x = c(-0.1,1.1),
  #      y = c(-0.1,1.1)) +
  NULL
FigS4B <- plot_dat %>%
  filter(Syncom == "Tolerant") %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_edges(aes(color = r), curvature = 0.05) +
  geom_nodes() +
  geom_nodelabel_repel(aes(label = paste(Genus, Strain, sep = "\n"), family = "NimbusMon"),  seed =1232, size= 2) +
  geom_nodelabel_repel(aes(label = paste(Genus, Strain, sep = "\n"),  fill = presence, family = "NimbusMon"), alpha = 0.3, seed=1232, size= 2) +
  ggtitle("Tolerant syncom") +
  scale_color_viridis_c(option = "C") +
  ggthemes::scale_fill_canva(palette = 'Corporate and sleek') +
  facet_grid(Timepoint~Treatment, scales = "free") +
  theme_blank() +
  theme(text = element_text(family = "NimbusMon"),
        strip.background = element_rect(fill = "white"),
        panel.border = element_rect(fill = NA)) +
  # lims(x = c(-0.1,1.1),
  #      y = c(-0.1,1.1)) +
  NULL
```

```{r}
FigS4A / FigS4B +
  plot_annotation(title = "Fig S4",tag_levels = "A") +
  plot_layout(guides = 'collect') &
  theme(text=element_text(family = "NimbusMon"), 
        legend.position = "bottom")
```